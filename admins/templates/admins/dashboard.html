{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="d-flex" role="tabpanel" style="min-height: 100vh;">
  <!-- Sidebar Navigation -->
  <nav class="flex-column nav nav-pills me-4 p-3 border rounded" style="min-width: 220px; background-color: #f8f9fa; max-height: calc(100vh - 100px); overflow-y: auto;" role="tablist" aria-orientation="vertical">
    <a class="nav-link mb-2 py-2 px-3 rounded active" id="overview-tab" data-bs-toggle="pill" href="#overview" role="tab" aria-controls="overview" aria-selected="true" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-house-door-fill me-2"></i> Overview
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="users-tab" data-bs-toggle="pill" href="#users" role="tab" aria-controls="users" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-people-fill me-2"></i> Users
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="appointments-tab" data-bs-toggle="pill" href="#appointments" role="tab" aria-controls="appointments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-calendar-check-fill me-2"></i> Appointments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="departments-tab" data-bs-toggle="pill" href="#departments" role="tab" aria-controls="departments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-building me-2"></i> Departments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="medications-tab" data-bs-toggle="pill" href="#medications" role="tab" aria-controls="medications" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-capsule me-2"></i> Medicine Management
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="billing-tab" data-bs-toggle="pill" href="#billing" role="tab" aria-controls="billing" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-wallet2 me-2"></i> Billing
    </a>
  </nav>

  <!-- Tab Content -->
  <div class="tab-content flex-grow-1 p-4">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <h3 class="mb-4">System Overview</h3>
      <div class="d-flex gap-3 flex-wrap mb-4">
        <div class="card text-white bg-primary flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-people-fill fs-1 mb-2"></i>
            <h5 class="card-title">{{ total_patients }}</h5>
            <p class="card-text">Total Patients</p>
          </div>
        </div>
        <div class="card text-white bg-success flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-person-badge fs-1 mb-2"></i>
            <h5 class="card-title">{{ total_doctors }}</h5>
            <p class="card-text">Total Doctors</p>
          </div>
        </div>
        <div class="card text-white bg-info flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-calendar-check fs-1 mb-2"></i>
            <h5 class="card-title">{{ todays_appointments }}</h5>
            <p class="card-text">Total Appointments</p>
          </div>
        </div>
        <div class="card text-white bg-warning flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-currency-dollar fs-1 mb-2"></i>
            <h5 class="card-title">â‚¹{{ total_revenue }}</h5>
            <p class="card-text">Total Revenue</p>
          </div>
        </div>
      </div>
      <div class="row gap-3">
        <div class="col-md-5 p-3 border rounded bg-white">
          <h5>Appointment Status</h5>
          <ul class="list-unstyled">
            {% for status in todays_appointment_status %}
              <li>
                <span class="badge rounded-pill 
                  {% if status.status == 'scheduled' %}bg-primary
                  {% elif status.status == 'completed' %}bg-success
                  {% elif status.status == 'cancelled' %}bg-danger
                  {% else %}bg-secondary{% endif %} me-2">&nbsp;</span>
                {{ status.status|capfirst }}: {{ status.count }}
              </li>
            {% empty %}
              <li>No appointments today.</li>
            {% endfor %}
          </ul>
        </div>
        <div class="col-md-5 p-3 border rounded bg-white">
          <h5>Financial Overview</h5>
          <ul class="list-unstyled">
            {% for finance in todays_financial_overview %}
              <li>
                {% if finance.is_paid %}
                  <span class="text-success fw-bold">Paid</span>
                {% else %}
                  <span class="text-warning fw-bold">Unpaid</span>
                {% endif %}
                : {{ finance.count }} (Total: ${{ finance.total_amount }})
              </li>
            {% empty %}
              <li>No billing today.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
      <h3 class="mb-4">User Management</h3>
      <div class="row mt-4">
        <div class="col-md-4">
          <a href="{% url 'admins:list_patients' %}" class="text-decoration-none">
            <div class="card text-white bg-primary mb-3">
              <div class="card-body">
                <h5 class="card-title">Patients</h5>
                <p class="card-text">Total Patients: {{ total_patients }}</p>
                <button class="btn btn-light">Manage Patients</button>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-4">
          <a href="{% url 'admins:list_doctors' %}" class="text-decoration-none">
            <div class="card text-white bg-success mb-3">
              <div class="card-body">
                <h5 class="card-title">Doctors</h5>
                <p class="card-text">Total Doctors: {{ total_doctors }}</p>
                <button class="btn btn-light">Manage Doctors</button>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-4">
          <a href="{% url 'admins:list_admins' %}" class="text-decoration-none">
            <div class="card text-white bg-warning mb-3">
              <div class="card-body">
                <h5 class="card-title">Admins</h5>
                <p class="card-text">Total Admins: {{ total_admins }}</p>
                <button class="btn btn-light">Manage Admins</button>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- Appointments Tab -->
    <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="appointments-tab">
      <h3 class="mb-4">All Appointments</h3>
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Patient</th>
            <th>Doctor</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for appointment in todays_appointments_list %}
          <tr>
            <td>{{ appointment.patient.get_full_name }}</td>
            <td>{{ appointment.doctor.get_full_name }}</td>
            <td>{{ appointment.schedule.date }}</td>
            <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
            <td>
              <span class="badge rounded-pill 
                {% if appointment.status == 'scheduled' %}bg-primary
                {% elif appointment.status == 'completed' %}bg-success
                {% elif appointment.status == 'cancelled' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ appointment.status }}
              </span>
            </td>
            <td>
              <a href="#" class="btn btn-sm btn-outline-info">View Details</a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6">No appointments today.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Departments Tab -->
    <div class="tab-pane fade" id="departments" role="tabpanel" aria-labelledby="departments-tab">
      <h3 class="mb-4">Department Management</h3>
      <a href="{% url 'admins:add_department' %}" class="btn btn-primary mb-3">+ Add Department</a>
      <div class="d-flex flex-wrap gap-3">
        {% for department in departments %}
        <div class="card p-3 flex-fill" style="min-width: 250px; max-width: 350px;">
          <h5>{{ department.name }}</h5>
          <p class="text-muted">{{ department.description }}</p>
          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'admins:edit_department' department.id %}" class="btn btn-outline-primary btn-sm">Edit</a>
            <a href="{% url 'admins:delete_department' department.id %}" class="btn btn-outline-danger btn-sm">Delete</a>
          </div>
        </div>
        {% empty %}
        <p>No departments found.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Medicine Management Tab -->
    <div class="tab-pane fade" id="medications" role="tabpanel" aria-labelledby="medications-tab">
      <h3 class="mb-4">Medicine Management</h3>
      <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addMedicationModal">
        + Add New Medicine
      </button>

      <!-- Search Bar -->
      <div class="mb-3">
        <input 
          type="text" 
          id="searchMedicines" 
          class="form-control" 
          placeholder="Search medicines by name, unit, or price..." 
          style="max-width: 400px;">
      </div>

      {% if medications %}
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="medications-table">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Price (â‚¹)</th>
                <th>Unit</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for med in medications %}
                {% if not med.is_active %}
                  <tr>
                    <td colspan="5" class="text-center text-muted bg-light py-3">
                      <em>Medicine "{{ med.name }}" is inactive.</em>
                      <a href="{% url 'admins:activate_medication' med.id %}" class="btn btn-sm btn-outline-success ms-3">Reactivate</a>
                    </td>
                  </tr>
                {% else %}
                  <tr data-search-term="{{ med.name|lower }} {{ med.unit|lower }} {{ med.price }}">
                    <td><strong>{{ med.name }}</strong></td>
                    <td>â‚¹{{ med.price|floatformat:2 }}</td>
                    <td>{{ med.unit|title }}</td>
                    <td>
                      <span class="badge bg-success">Active</span>
                    </td>
                    <td>
                      <!-- Edit Button -->
                      <button type="button" 
                              class="btn btn-sm btn-outline-primary me-2" 
                              data-bs-toggle="modal" 
                              data-bs-target="#editMedModal-{{ med.id }}">
                        Edit
                      </button>

                      <!-- Deactivate Button -->
                      <a href="{% url 'admins:deactivate_medication' med.id %}" 
                         class="btn btn-sm btn-outline-danger"
                         onclick="return confirm('Deactivate {{ med.name }}? This will hide it from prescribing.')">
                        Deactivate
                      </a>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <small class="text-muted">
            Showing {{ medications.start_index }} to {{ medications.end_index }} of {{ medications.paginator.count }} medicines
          </small>
          <nav>
            <ul class="pagination pagination-sm mb-0">
              {% if medications.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1">&laquo; First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ medications.previous_page_number }}">Previous</a>
                </li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link">Page {{ medications.number }} of {{ medications.paginator.num_pages }}</span>
              </li>

              {% if medications.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ medications.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ medications.paginator.num_pages }}">Last &raquo;</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <div class="alert alert-info">No medicines found. <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicationModal">Add one</button>.</div>
      {% endif %}

      <!-- Add Medicine Modal -->
      <div class="modal fade" id="addMedicationModal" tabindex="-1" aria-labelledby="addMedicationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="{% url 'admins:add_medication_with_stock' %}">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="addMedicationModalLabel">Add New Medicine & Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Medicine Name</label>
                  <input type="text" name="name" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Price (â‚¹)</label>
                  <input type="number" step="0.01" name="price" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Unit</label>
                  <input type="text" name="unit" class="form-control" value="tablet" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Safety Warnings (Optional)</label>
                  <textarea name="safety_warnings" class="form-control" rows="3" placeholder="e.g., Avoid alcohol, Do not combine with ibuprofen"></textarea>
                </div>

                <hr>
                <h6>Add Initial Stock</h6>
                <div class="mb-3">
                  <label class="form-label">Quantity in Stock</label>
                  <input type="number" name="quantity" class="form-control" min="0" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Batch Number (Optional)</label>
                  <input type="text" name="batch_number" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">Expiry Date (Optional)</label>
                  <input type="date" name="expiry_date" class="form-control">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Medicine & Stock</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- All Edit Medicine Modals -->
      {% for med in medications %}
        {% if med.id %}
          <div class="modal fade" id="editMedModal-{{ med.id }}" tabindex="-1" aria-labelledby="editMedModalLabel-{{ med.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <form method="post" action="{% url 'admins:edit_medication' med.id %}">
                  {% csrf_token %}
                  <div class="modal-header">
                    <h5 class="modal-title" id="editMedModalLabel-{{ med.id }}">Edit: {{ med.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label">Medicine Name</label>
                      <input type="text" name="name" class="form-control" value="{{ med.name }}" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Price (â‚¹)</label>
                      <input type="number" step="0.01" name="price" class="form-control" value="{{ med.price }}" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Unit</label>
                      <input type="text" name="unit" class="form-control" value="{{ med.unit }}" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Safety Warnings</label>
                      <textarea name="safety_warnings" class="form-control" rows="3">{{ med.safety_warnings }}</textarea>
                    </div>

                    <hr>
                    <h6>Add Stock (Optional)</h6>
                    <div class="mb-3">
                      <label class="form-label">Quantity to Add</label>
                      <input type="number" name="quantity" class="form-control" min="0" value="0">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Batch Number</label>
                      <input type="text" name="batch_number" class="form-control">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Expiry Date</label>
                      <input type="date" name="expiry_date" class="form-control">
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Billing Tab -->
    <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
      <h3 class="mb-4">Billing Management</h3>
      <a href="{% url 'admins:create_invoice' %}" class="btn btn-primary mb-3">+ Create Invoice</a>
      <p>Billing management features will be displayed here.</p>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Tab Persistence: Restore active tab from URL hash
    const hash = window.location.hash;
    if (hash) {
      const tabTrigger = document.querySelector(`a[data-bs-toggle="pill"][href="${hash}"]`);
      if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
    }

    // Update URL hash on tab click
    const tabButtons = document.querySelectorAll('a[data-bs-toggle="pill"]');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', function () {
        history.pushState(null, null, this.getAttribute('href'));
      });
    });

    // Live Search for Medicine Table
    const searchInput = document.getElementById('searchMedicines');
    const tableRows = document.querySelectorAll('#medications-table tbody tr');

    if (searchInput && tableRows.length > 0) {
      searchInput.addEventListener('keyup', function () {
        const term = searchInput.value.toLowerCase().trim();
        tableRows.forEach(row => {
          // Skip full-row inactive messages
          if (row.querySelector('td[colspan="5"]')) return;

          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(term) ? '' : 'none';
        });
      });
    }
  });
</script>
{% endblock %}