{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="d-flex" role="tabpanel" style="min-height: 100vh;">
  <nav class="flex-column nav nav-pills me-4 p-3 border rounded" style="min-width: 220px; background-color: #f8f9fa; max-height: calc(100vh - 100px); overflow-y: auto;" role="tablist" aria-orientation="vertical">
    <a class="nav-link mb-2 py-2 px-3 rounded active" id="overview-tab" data-bs-toggle="pill" href="#overview" role="tab" aria-controls="overview" aria-selected="true" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-house-door-fill me-2"></i> Overview
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="users-tab" data-bs-toggle="pill" href="#users" role="tab" aria-controls="users" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-people-fill me-2"></i> Users
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="appointments-tab" data-bs-toggle="pill" href="#appointments" role="tab" aria-controls="appointments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-calendar-check-fill me-2"></i> Appointments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="departments-tab" data-bs-toggle="pill" href="#departments" role="tab" aria-controls="departments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-building me-2"></i> Departments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="billing-tab" data-bs-toggle="pill" href="#billing" role="tab" aria-controls="billing" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-wallet2 me-2"></i> Billing
    </a>
  </nav>
  <div class="tab-content flex-grow-1">
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <h3 class="mb-4">System Overview</h3>
      <div class="d-flex gap-3 flex-wrap mb-4">
        <div class="card text-white bg-primary flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-people-fill fs-1 mb-2"></i>
            <h5 class="card-title">{{ total_patients }}</h5>
            <p class="card-text">Total Patients</p>
          </div>
        </div>
        <div class="card text-white bg-success flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-person-badge fs-1 mb-2"></i>
            <h5 class="card-title">{{ total_doctors }}</h5>
            <p class="card-text">Total Doctors</p>
          </div>
        </div>
        <div class="card text-white bg-info flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-calendar-check fs-1 mb-2"></i>
            <h5 class="card-title">{{ todays_appointments }}</h5>
            <p class="card-text">Total Appointments</p>
          </div>
        </div>
        <div class="card text-white bg-warning flex-fill" style="min-width: 150px;">
          <div class="card-body text-center">
            <i class="bi bi-currency-dollar fs-1 mb-2"></i>
            <h5 class="card-title">${{ total_revenue }}</h5>
            <p class="card-text">Total Revenue</p>
          </div>
        </div>
      </div>
      <div class="row gap-3">
        <div class="col-md-5 p-3 border rounded bg-white">
          <h5>Appointment Status</h5>
          <ul class="list-unstyled">
            {% for status in todays_appointment_status %}
              <li>
                <span class="badge rounded-pill 
                  {% if status.status == 'scheduled' %}bg-primary
                  {% elif status.status == 'completed' %}bg-success
                  {% elif status.status == 'cancelled' %}bg-danger
                  {% else %}bg-secondary{% endif %} me-2">&nbsp;</span>
                {{ status.status|capfirst }}: {{ status.count }}
              </li>
            {% empty %}
              <li>No appointments today.</li>
            {% endfor %}
          </ul>
        </div>
        <div class="col-md-5 p-3 border rounded bg-white">
          <h5>Financial Overview</h5>
          <ul class="list-unstyled">
            {% for finance in todays_financial_overview %}
              <li>
                {% if finance.is_paid %}
                  <span class="text-success fw-bold">Paid</span>
                {% else %}
                  <span class="text-warning fw-bold">Unpaid</span>
                {% endif %}
                : {{ finance.count }} (Total: ${{ finance.total_amount }})
              </li>
            {% empty %}
              <li>No billing today.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
      <h3 class="mb-4">User Management</h3>
      <div class="row mt-4">
        <div class="col-md-4">
          <a href="{% url 'admins:list_patients' %}" class="text-decoration-none">
            <div class="card text-white bg-primary mb-3">
              <div class="card-body">
                <h5 class="card-title">Patients</h5>
                <p class="card-text">Total Patients: {{ total_patients }}</p>
                <button class="btn btn-light">Manage Patients</button>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-4">
          <a href="{% url 'admins:list_doctors' %}" class="text-decoration-none">
            <div class="card text-white bg-success mb-3">
              <div class="card-body">
                <h5 class="card-title">Doctors</h5>
                <p class="card-text">Total Doctors: {{ total_doctors }}</p>
                <button class="btn btn-light">Manage Doctors</button>
              </div>
            </div>
          </a>
        </div>
        <div class="col-md-4">
          <a href="{% url 'admins:list_admins' %}" class="text-decoration-none">
            <div class="card text-white bg-warning mb-3">
              <div class="card-body">
                <h5 class="card-title">Admins</h5>
                <p class="card-text">Total Admins: {{ total_admins }}</p>
                <button class="btn btn-light">Manage Admins</button>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="appointments-tab">
      <h3 class="mb-4">All Appointments</h3>
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Patient</th>
            <th>Doctor</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for appointment in todays_appointments_list %}
          <tr>
            <td>{{ appointment.patient.get_full_name }}</td>
            <td>{{ appointment.doctor.get_full_name }}</td>
            <td>{{ appointment.schedule.date }}</td>
            <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
            <td>
              <span class="badge rounded-pill 
                {% if appointment.status == 'scheduled' %}bg-primary
                {% elif appointment.status == 'completed' %}bg-success
                {% elif appointment.status == 'cancelled' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ appointment.status }}
              </span>
            </td>
            <td>
              <a href="{% url 'admins:appointment_detail' appointment.id %}" class="btn btn-sm btn-outline-info">View Details</a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6">No appointments today.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="tab-pane fade" id="departments" role="tabpanel" aria-labelledby="departments-tab">
      <h3 class="mb-4">Department Management</h3>
      <a href="{% url 'admins:add_department' %}" class="btn btn-primary mb-3">+ Add Department</a>
      <div class="d-flex flex-wrap gap-3">
        {% for department in departments %}
        <div class="card p-3 flex-fill" style="min-width: 250px; max-width: 350px;">
          <h5>{{ department.name }}</h5>
          <p class="text-muted">{{ department.description }}</p>
          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'admins:edit_department' department.id %}" class="btn btn-outline-primary btn-sm">Edit</a>
            <a href="{% url 'admins:delete_department' department.id %}" class="btn btn-outline-danger btn-sm">Delete</a>
          </div>
        </div>
        {% empty %}
        <p>No departments found.</p>
        {% endfor %}
      </div>
    </div>
    <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
      <h3 class="mb-4">Billing Management</h3>
      <a href="{% url 'admins:create_invoice' %}" class="btn btn-primary mb-3">+ Create Invoice</a>
      <p>Billing management features will be displayed here.</p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Get the hash from URL (e.g., #users)
    const hash = window.location.hash;

    // If there's a valid tab ID in the hash
    if (hash) {
      const tabTrigger = document.querySelector(`a[data-bs-toggle="pill"][href="${hash}"]`);
      if (tabTrigger) {
        // Activate the tab
        new bootstrap.Tab(tabTrigger).show();
      }
    }

    // Optional: Update URL hash when a tab is clicked
    const tabButtons = document.querySelectorAll('a[data-bs-toggle="pill"]');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', function () {
        history.pushState(null, null, this.getAttribute('href'));
      });
    });
  });
</script>
{% endblock %}
