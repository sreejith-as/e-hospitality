{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Appointment History</h2>
    <div>
      <a href="{% url 'patients:book_appointment_form' %}" class="btn btn-primary">Book New Appointment</a>
      <a href="{% url 'patients:dashboard' %}#appointments" class="btn btn-outline-secondary">Go To Dashboard</a>
    </div>
  </div>

  <!-- Upcoming Appointments Section -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-calendar-check me-2"></i>Upcoming Appointments
      </h5>
    </div>
    <div class="card-body">
      {% if upcoming_page.object_list %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Doctor</th>
                <th>Date</th>
                <th>Time</th>
                <th>Reason/Symptoms</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for appointment in upcoming_page %}
              <tr>
                <td>
                  <strong>Dr. {{ appointment.doctor.get_full_name }}</strong>
                  <br>
                  <small class="text-muted">{{ appointment.doctor.email }}</small>
                </td>
                <td>{{ appointment.schedule.date|date:"M d, Y" }}</td>
                <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
                <td>{{ appointment.symptoms|default:"Not specified"|truncatechars:50 }}</td>
                <td>
                  <span class="badge bg-primary">Scheduled</span>
                </td>
                <td>
                  {% if appointment.status == 'booked' %}
                      <a href="{% url 'patients:edit_appointment' appointment.id %}" class="btn btn-sm btn-primary">Edit</a>
                      <a href="{% url 'patients:cancel_appointment' appointment.id %}" class="btn btn-sm btn-outline-danger">Cancel</a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination for Upcoming -->
        <div class="d-flex justify-content-center mt-3">
          <nav aria-label="Upcoming appointments pagination">
            <ul class="pagination pagination-sm">
              {% if upcoming_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page_upcoming={{ upcoming_page.previous_page_number }}">&laquo; Previous</a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">&laquo; Previous</span>
                </li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link">Page {{ upcoming_page.number }} of {{ upcoming_page.paginator.num_pages }}</span>
              </li>

              {% if upcoming_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page_upcoming={{ upcoming_page.next_page_number }}">Next &raquo;</a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Next &raquo;</span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <div class="text-center py-4">
          <i class="bi bi-calendar-x fs-1 text-muted"></i>
          <p class="text-muted mt-2">No upcoming appointments found.</p>
          <a href="{% url 'patients:book_appointment_form' %}" class="btn btn-primary">Book An Appointment</a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Past Appointments Section -->
  <div class="card">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">
        <i class="bi bi-clock-history me-2"></i>Past Appointments
      </h5>
    </div>
    <div class="card-body">
      {% if past_page.object_list %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Doctor</th>
                <th>Date</th>
                <th>Time</th>
                <th>Reason/Symptoms</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for appointment in past_page %}
              <tr>
                <td>
                  <strong>Dr. {{ appointment.doctor.get_full_name }}</strong>
                  <br>
                  <small class="text-muted">{{ appointment.doctor.email }}</small>
                </td>
                <td>{{ appointment.schedule.date|date:"M d, Y" }}</td>
                <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
                <td>{{ appointment.symptoms|default:"Not specified"|truncatechars:50 }}</td>
                <td>
                  {% if appointment.status == 'completed' %}
                    <span class="badge bg-success">Completed</span>
                  {% elif appointment.status == 'cancelled' %}
                    <span class="badge bg-danger">Cancelled</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ appointment.status|title }}</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'patients:visit_detail' appointment.id %}" class="btn btn-sm btn-primary" title="View Details">
                    View Details
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination for Past -->
        <div class="d-flex justify-content-center mt-3">
          <nav aria-label="Past appointments pagination">
            <ul class="pagination pagination-sm">
              {% if past_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page_past={{ past_page.previous_page_number }}">&laquo; Previous</a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">&laquo; Previous</span>
                </li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link">Page {{ past_page.number }} of {{ past_page.paginator.num_pages }}</span>
              </li>

              {% if past_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page_past={{ past_page.next_page_number }}">Next &raquo;</a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Next &raquo;</span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <div class="text-center py-4">
          <i class="bi bi-calendar-x fs-1 text-muted"></i>
          <p class="text-muted mt-2">No past appointments found.</p>
          <p class="text-muted">Your appointment history will appear here after your visits.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mt-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ upcoming_page.paginator.count }}</h5>
          <p class="card-text text-muted">Upcoming</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ past_page.paginator.count }}</h5>
          <p class="card-text text-muted">Past</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ total_appointments_count }}</h5>
          <p class="card-text text-muted">Total</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ completed_count }}</h5>
          <p class="card-text text-muted">Completed</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}