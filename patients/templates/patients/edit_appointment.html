{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <!-- Page Title -->
      <h2 class="mb-4">
        <i class="bi bi-calendar-check"></i> Edit Appointment
      </h2>

      <!-- Current Appointment Card -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Current Appointment Details</h5>
          <dl class="row mb-0">
            <dt class="col-sm-3">Doctor</dt>
            <dd class="col-sm-9">{{ appointment.doctor.get_full_name }}</dd>

            <dt class="col-sm-3">Date</dt>
            <dd class="col-sm-9">{{ appointment.schedule.date|date:"M d, Y" }}</dd>

            <dt class="col-sm-3">Time</dt>
            <dd class="col-sm-9">{{ appointment.schedule.start_time|time:"h:i A" }}</dd>

            <dt class="col-sm-3">Reason</dt>
            <dd class="col-sm-9">{{ appointment.symptoms|default:"N/A" }}</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">
              {% if appointment.status == 'booked' %}
                <span class="badge bg-primary">Scheduled</span>
              {% elif appointment.status == 'completed' %}
                <span class="badge bg-success">Completed</span>
              {% elif appointment.status == 'cancelled' %}
                <span class="badge bg-danger">Cancelled</span>
              {% else %}
                <span class="badge bg-secondary">{{ appointment.status|title }}</span>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>

      <!-- Error Display: Non-Field Errors -->
      {% if form.non_field_errors %}
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
          {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
          {% endfor %}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}

      <!-- Form -->
      <form method="post" id="booking-form">
        {% csrf_token %}

        <!-- Department -->
        <div class="mb-3">
          {{ form.department.label_tag }}
          {{ form.department }}
          {% if form.department.errors %}
            <div class="text-danger small mt-1">{{ form.department.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Doctor -->
        <div class="mb-3">
          {{ form.doctor.label_tag }}
          {{ form.doctor }}
          {% if form.doctor.errors %}
            <div class="text-danger small mt-1">{{ form.doctor.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Date -->
        <div class="mb-3">
          {{ form.date.label_tag }}
          {{ form.date }}
          {% if form.date.errors %}
            <div class="text-danger small mt-1">{{ form.date.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Time -->
        <div class="mb-3">
          {{ form.time.label_tag }}
          {{ form.time }}
          {% if form.time.errors %}
            <div class="text-danger small mt-1">{{ form.time.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Symptoms -->
        <div class="mb-3">
          {{ form.symptoms.label_tag }}
          {{ form.symptoms }}
          {% if form.symptoms.errors %}
            <div class="text-danger small mt-1">{{ form.symptoms.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Buttons -->
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Update Appointment
          </button>
          <a href="{% url 'patients:appointments' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Dynamic Loading Script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const deptSelect = document.getElementById('id_department');
  const doctorSelect = document.getElementById('id_doctor');
  const dateInput = document.getElementById('id_date');
  const timeSelect = document.getElementById('id_time');

  // Load doctors when department changes
  deptSelect.addEventListener('change', function () {
    const deptId = this.value;
    doctorSelect.innerHTML = '<option value="">Loading...</option>';
    timeSelect.innerHTML = '<option value="">Select date to load time slots</option>';

    if (!deptId) {
      doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
      return;
    }

    fetch(`{% url 'patients:get_doctors_by_department' %}?department_id=${deptId}`)
      .then(response => response.json())
      .then(data => {
        doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
        data.doctors.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name;
          doctorSelect.appendChild(option);
        });
      })
      .catch(() => {
        doctorSelect.innerHTML = '<option value="">Error loading doctors</option>';
      });
  });

  // Load available time slots when doctor or date changes
  function updateTimeSlots() {
    const doctorId = doctorSelect.value;
    const date = dateInput.value;
    if (!doctorId || !date) {
      timeSelect.innerHTML = '<option value="">Select doctor and date</option>';
      return;
    }

    timeSelect.innerHTML = '<option value="">Loading...</option>';
    fetch(`{% url 'patients:get_available_time_slots' %}?doctor_id=${doctorId}&date=${date}`)
      .then(response => response.json())
      .then(data => {
        timeSelect.innerHTML = '<option value="">Select Time</option>';
        if (data.available_slots.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No slots available';
          option.disabled = true;
          timeSelect.appendChild(option);
        } else {
          data.available_slots.forEach(slot => {
            const option = document.createElement('option');
            option.value = slot;
            option.textContent = slot;
            timeSelect.appendChild(option);
          });
        }
      })
      .catch(() => {
        timeSelect.innerHTML = '<option value="">Error loading time slots</option>';
      });
  }

  doctorSelect.addEventListener('change', updateTimeSlots);
  dateInput.addEventListener('change', updateTimeSlots);
});
</script>

{% endblock %}