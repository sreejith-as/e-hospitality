{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-3, 5" >
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <!-- Page Title -->
      <div class="d-flex align-items-center mb-4">
        <i class="bi bi-calendar-check text-primary me-2" style="font-size: 1.75rem;"></i>
        <h2 class="mb-0 text-primary">Edit Appointment</h2>
      </div>

      <!-- Current Appointment Card -->
      <div class="card shadow-sm border rounded mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="bi bi-info-circle text-info me-1"></i>
            Current Appointment Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="d-flex">
                <strong class="text-muted me-2" style="min-width: 80px;">Doctor:</strong>
                <span>Dr. {{ appointment.doctor.get_full_name }}</span>
              </div>
              <div class="d-flex">
                <strong class="text-muted me-2" style="min-width: 80px;">Date:</strong>
                <span>{{ appointment.schedule.date|date:"M d, Y" }}</span>
              </div>
              <div class="d-flex">
                <strong class="text-muted me-2" style="min-width: 80px;">Time:</strong>
                <span>{{ appointment.schedule.start_time|time:"h:i A" }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex flex-column">
                <div class="mb-1">
                  <strong class="text-muted">Reason:</strong>
                  <span class="ms-1">{{ appointment.symptoms|default:"N/A" }}</span>
                </div>
                <div>
                  <strong class="text-muted">Status:</strong>
                  <span class="ms-1">
                    {% if appointment.status == 'booked' %}
                      <span class="badge bg-primary">Scheduled</span>
                    {% elif appointment.status == 'completed' %}
                      <span class="badge bg-success">Completed</span>
                    {% elif appointment.status == 'cancelled' %}
                      <span class="badge bg-danger">Cancelled</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ appointment.status|title }}</span>
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Messages -->
      {% if form.non_field_errors %}
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-1"></i>
          {% for error in form.non_field_errors %}
            <div><strong>Error:</strong> {{ error }}</div>
          {% endfor %}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}

      <!-- Edit Form -->
      <form method="post" id="booking-form" class="shadow-sm p-4 border rounded">
        {% csrf_token %}

        <div class="row g-3">
          <!-- Department -->
          <div class="col-md-6">
            <label for="{{ form.department.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-building text-primary me-1"></i>
              {{ form.department.label }}
            </label>
            {{ form.department }}
            {% if form.department.errors %}
              <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> {{ form.department.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Doctor -->
          <div class="col-md-6">
            <label for="{{ form.doctor.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-person-badge text-primary me-1"></i>
              {{ form.doctor.label }}
            </label>
            {{ form.doctor }}
            {% if form.doctor.errors %}
              <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> {{ form.doctor.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Date -->
          <div class="col-md-6">
            <label for="{{ form.date.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-calendar-event text-success me-1"></i>
              {{ form.date.label }}
            </label>
            {{ form.date }}
            {% if form.date.errors %}
              <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> {{ form.date.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Time -->
          <div class="col-md-6">
            <label for="{{ form.time.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-clock text-success me-1"></i>
              {{ form.time.label }}
            </label>
            {{ form.time }}
            {% if form.time.errors %}
              <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> {{ form.time.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Symptoms -->
          <div class="col-12">
            <label for="{{ form.symptoms.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-clipboard-pulse text-danger me-1"></i>
              {{ form.symptoms.label }}
            </label>
            {{ form.symptoms }}
            {% if form.symptoms.errors %}
              <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> {{ form.symptoms.errors.0 }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <a href="{% url 'patients:appointments' %}" class="btn btn-outline-secondary px-4">
            <i class="bi bi-x-circle me-1"></i> Cancel
          </a>
          <button type="submit" class="btn btn-primary px-4">
            <i class="bi bi-save me-1"></i> Update Appointment
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Dynamic Loading Script (Improved) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const deptSelect = document.getElementById('id_department');
  const doctorSelect = document.getElementById('id_doctor');
  const dateInput = document.getElementById('id_date');
  const timeSelect = document.getElementById('id_time');

  // Show loading state
  function setLoading(selectEl, message) {
    selectEl.innerHTML = `<option value="">${message}</option>`;
  }

  // Load doctors when department changes
  deptSelect.addEventListener('change', function () {
    const deptId = this.value;
    setLoading(doctorSelect, 'Loading...');
    setLoading(timeSelect, 'Select date to load slots');

    if (!deptId) {
      doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
      return;
    }

    fetch(`{% url 'patients:get_doctors_by_department' %}?department_id=${deptId}`)
      .then(response => response.json())
      .then(data => {
        doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
        data.doctors.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name;
          if (d.id == "{{ appointment.doctor.id }}") option.selected = true;
          doctorSelect.appendChild(option);
        });
        // Trigger time slot update if date is already selected
        if (dateInput.value) updateTimeSlots();
      })
      .catch(() => {
        doctorSelect.innerHTML = '<option value="">Error loading doctors</option>';
      });
  });

  // Load available time slots
  function updateTimeSlots() {
    const doctorId = doctorSelect.value;
    const date = dateInput.value;
    if (!doctorId || !date) {
      setLoading(timeSelect, 'Select doctor and date');
      return;
    }

    setLoading(timeSelect, 'Loading...');
    fetch(`{% url 'patients:get_available_time_slots' %}?doctor_id=${doctorId}&date=${date}`)
      .then(response => response.json())
      .then(data => {
        timeSelect.innerHTML = '<option value="">Select Time</option>';
        if (data.available_slots.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No slots available';
          option.disabled = true;
          timeSelect.appendChild(option);
        } else {
          data.available_slots.forEach(slot => {
            const option = document.createElement('option');
            option.value = slot;
            option.textContent = slot;
            if (slot === "{{ appointment.schedule.start_time|time:'H:i' }}") {
              option.selected = true;
            }
            timeSelect.appendChild(option);
          });
        }
      })
      .catch(() => {
        timeSelect.innerHTML = '<option value="">Error loading time slots</option>';
      });
  }

  doctorSelect.addEventListener('change', updateTimeSlots);
  dateInput.addEventListener('change', updateTimeSlots);

  // Pre-fill on load
  window.addEventListener('load', () => {
    if (deptSelect.value && !doctorSelect.value) {
      deptSelect.dispatchEvent(new Event('change'));
    }
  });
});
</script>

<!-- Optional: Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}