{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" role="tabpanel" style="min-height: calc(100vh - 200px);">
  <!-- Sidebar Navigation -->
  <nav class="flex-column nav nav-pills me-4 p-3 border rounded" style="min-width: 220px; background-color: #f8f9fa; max-height: calc(100vh - 200px); overflow-y: auto;" role="tablist" aria-orientation="vertical">
    <a class="nav-link mb-2 py-2 px-3 rounded active" id="overview-tab" data-bs-toggle="pill" href="#overview" role="tab" aria-controls="overview" aria-selected="true" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-house-fill me-2"></i> Overview
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="appointments-tab" data-bs-toggle="pill" href="#appointments" role="tab" aria-controls="appointments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-calendar-check-fill me-2"></i> Appointments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="medical-records-tab" data-bs-toggle="pill" href="#medical-records" role="tab" aria-controls="medical-records" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-file-earmark-text-fill me-2"></i> Medical Records
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="billing-tab" data-bs-toggle="pill" href="#billing" role="tab" aria-controls="billing" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-credit-card-2-front-fill me-2"></i> Billing
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="education-tab" data-bs-toggle="pill" href="#education" role="tab" aria-controls="education" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-book-fill me-2"></i> Education
    </a>
  </nav>

  <!-- Tab Content -->
  <div class="tab-content flex-grow-1 p-3 border rounded bg-white" style="max-height: calc(100vh - 200px); overflow-y: auto;">

    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="row g-3 mb-4">
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-calendar-check-fill fs-1 text-primary"></i>
            <h2>{{ upcoming_appointments|length }}</h2>
            <p>Upcoming Appointments</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-file-earmark-text-fill fs-1 text-success"></i>
            <h2>{{ medical_records_count }}</h2>
            <p>Medical Records</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-capsule-pill fs-1 text-info"></i>
            <h2>{{ active_prescriptions|length }}</h2>
            <p>Active Prescriptions</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-credit-card-2-front-fill fs-1 text-warning"></i>
            <h2>{{ unpaid_bills|length }}</h2>
            <p>Unpaid Bills</p>
          </div>
        </div>
      </div>
      <div class="card p-3">
        <h4>Recent Activity</h4>
        {% if recent_activity %}
          <ul>
            {% for activity in recent_activity %}
              <li>{{ activity }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No recent activity to display.</p>
        {% endif %}
      </div>
    </div>

    <!-- Appointments Tab -->
    <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="appointments-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Appointments</h3>
        <div>
          <a href="{% url 'patients:book_appointment_form' %}" class="btn btn-primary me-2">Book New Appointment</a>
          <a href="{% url 'patients:appointments' %}" class="btn btn-outline-secondary">Appointment History</a>
        </div>
      </div>
      <div class="table-responsive">
        <h5 class="text-primary mb-3">Upcoming Appointments</h5>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Doctor</th>
              <th>Date</th>
              <th>Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in upcoming_appointments %}
            <tr>
              <td>{{ appointment.doctor.get_full_name }}</td>
              <td>{{ appointment.schedule.date }}</td>
              <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
              <td>
                {% if appointment.status == 'booked' %}
                  <span class="badge bg-primary">Scheduled</span>
                {% elif appointment.status == 'completed' %}
                  <span class="badge bg-success">Completed</span>
                {% elif appointment.status == 'cancelled' %}
                  <span class="badge bg-danger">Cancelled</span>
                {% endif %}
              </td>
              <td>
                {% if appointment.status == 'booked' %}
                  <a href="{% url 'patients:edit_appointment' appointment.id %}" class="btn btn-sm btn-primary">Edit</a>
                  <a href="{% url 'patients:cancel_appointment' appointment.id %}" class="btn btn-sm btn-danger">Cancel</a>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center">No upcoming appointments found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Medical Records Tab -->
    <div class="tab-pane fade" id="medical-records" role="tabpanel" aria-labelledby="medical-records-tab">
      <h3>Medical Records</h3>
      {% if medical_records_page %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for event in medical_records_page %}
                <tr>
                  <td>{{ event.date|date:"M d, Y" }}</td>
                  <td>
                    {% if event.type == 'visit' %}
                      <span class="badge bg-info">Visit</span>
                    {% elif event.type == 'prescription' %}
                      <span class="badge bg-success">Prescription</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ event.type|title }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if event.type == 'visit' %}
                      <strong>Doctor:</strong> Dr. {{ event.object.doctor.get_full_name }}<br>
                      {% if event.object.diagnosis %}
                        <strong>Diagnosis:</strong> {{ event.object.diagnosis }}<br>
                      {% endif %}
                      {% if event.object.symptoms %}
                        <strong>Symptoms:</strong> {{ event.object.symptoms }}<br>
                      {% endif %}
                      {% if event.object.notes %}
                        <strong>Notes:</strong> {{ event.object.notes }}
                      {% endif %}
                    {% elif event.type == 'prescription' %}
                      <strong>Doctor:</strong> Dr. {{ event.object.doctor.get_full_name }}<br>
                      <strong>Medicine:</strong> {{ event.object.medication.name }}<br>
                      <strong>Dosage:</strong> {{ event.object.dosage }}
                      {% if event.object.frequency %}
                        <strong>, Frequency:</strong> {{ event.object.frequency }}
                      {% endif %}
                      {% if event.object.duration_days %}
                        <strong>, Duration:</strong> {{ event.object.duration_days }} days
                      {% endif %}
                      {% if event.object.instructions %}
                        <br><strong>Instructions:</strong> {{ event.object.instructions }}
                      {% endif %}
                    {% else %}
                      {{ event.object }}
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="3" class="text-center">No medical records found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if medical_records_page.has_other_pages %}
          <div class="d-flex justify-content-center mt-3">
            <nav aria-label="Medical Records Pagination">
              <ul class="pagination pagination-sm">
                {% if medical_records_page.has_previous %}
                  <li class="page-item"><a class="page-link" href="?page_medical_records={{ medical_records_page.previous_page_number }}#medical-records">Previous</a></li>
                {% endif %}
                <li class="page-item disabled"><span class="page-link">Page {{ medical_records_page.number }} of {{ medical_records_page.paginator.num_pages }}</span></li>
                {% if medical_records_page.has_next %}
                  <li class="page-item"><a class="page-link" href="?page_medical_records={{ medical_records_page.next_page_number }}#medical-records">Next</a></li>
                {% endif %}
              </ul>
            </nav>
          </div>
        {% endif %}
      {% else %}
        <div class="alert alert-info">No medical records yet.</div>
      {% endif %}
    </div>

    <!-- Billing Tab -->
    <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
      <h3>Billing</h3>
      {% if bills_page %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Doctor</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for bill in bills_page %}
                <tr>
                  <td>{{ bill.created_at|date:"M d, Y" }}</td>
                  <td>
                    {% if bill.appointment %}
                      Dr. {{ bill.appointment.doctor.get_full_name }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>{{ bill.description|truncatewords:10 }}</td>
                  <td>â‚¹{{ bill.amount }}</td>
                  <td>
                    {% if bill.is_paid %}
                      <span class="badge bg-success">Paid</span>
                    {% else %}
                      <span class="badge bg-warning">Unpaid</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if not bill.is_paid %}
                      <a href="{% url 'patients:pay_bill' bill.id %}" class="btn btn-sm btn-success">Pay</a>
                    {% else %}
                      <span class="text-muted">Paid</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No bills yet.</div>
      {% endif %}
    </div>

    <!-- Education Tab -->
    <div class="tab-pane fade" id="education" role="tabpanel" aria-labelledby="education-tab">
      <h3>Health Education</h3>
      <div class="row row-cols-1 row-cols-md-3 g-3 mt-3">
        <div class="col"><div class="card p-3 shadow-sm"><h5>Healthy Eating</h5><p>Learn about balanced diets and nutrition.</p></div></div>
        <div class="col"><div class="card p-3 shadow-sm"><h5>Exercise Tips</h5><p>Guidance on staying active and fit.</p></div></div>
        <div class="col"><div class="card p-3 shadow-sm"><h5>Mental Health</h5><p>Resources for mental well-being.</p></div></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
