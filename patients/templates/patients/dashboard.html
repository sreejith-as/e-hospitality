{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" role="tabpanel" style="min-height: 100vh;">
  <nav class="flex-column nav nav-pills me-4 p-3 border rounded" style="min-width: 220px; background-color: #f8f9fa; max-height: calc(100vh - 100px); overflow-y: auto;" role="tablist" aria-orientation="vertical">
    <a class="nav-link mb-2 py-2 px-3 rounded active" id="overview-tab" data-bs-toggle="pill" href="#overview" role="tab" aria-controls="overview" aria-selected="true" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-house-fill me-2"></i> Overview
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="appointments-tab" data-bs-toggle="pill" href="#appointments" role="tab" aria-controls="appointments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-calendar-check-fill me-2"></i> Appointments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="medical-records-tab" data-bs-toggle="pill" href="#medical-records" role="tab" aria-controls="medical-records" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-file-earmark-text-fill me-2"></i> Medical Records
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="active-prescriptions-tab" data-bs-toggle="pill" href="#prescriptions" role="tab" aria-controls="active-prescriptions" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-capsule-pill me-2"></i> Prescriptions
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="billing-tab" data-bs-toggle="pill" href="#billing" role="tab" aria-controls="billing" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-credit-card-2-front-fill me-2"></i> Billing
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="education-tab" data-bs-toggle="pill" href="#education" role="tab" aria-controls="education" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-book-fill me-2"></i> Education
    </a>
  </nav>
  <div class="tab-content flex-grow-1 p-3 border rounded bg-white">
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="row g-3 mb-4">
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-calendar-check-fill fs-1 text-primary"></i>
            <h2>{{ upcoming_appointments|length }}</h2>
            <p>Upcoming Appointments</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-file-earmark-text-fill fs-1 text-success"></i>
            <h2>{{ medical_records_count }}</h2>
            <p>Medical Records</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-capsule-pill fs-1 text-info"></i>
            <h2>{{ active_prescriptions|length }}</h2>
            <p>Active Prescriptions</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-credit-card-2-front-fill fs-1 text-warning"></i>
            <h2>{{ unpaid_bills|length }}</h2>
            <p>Unpaid Bills</p>
          </div>
        </div>
      </div>
      <div class="card p-3">
        <h4>Recent Activity</h4>
        {% if recent_activity %}
          <ul>
            {% for activity in recent_activity %}
              <li>{{ activity }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No recent activity to display.</p>
        {% endif %}
      </div>
    </div>
    <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="appointments-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Appointments</h3>
        <div>
          <a href="{% url 'patients:book_appointment_form' %}" class="btn btn-primary me-2">Book New Appointment</a>
          <a href="{% url 'patients:appointments' %}" class="btn btn-outline-secondary">Appointment History</a>
        </div>
      </div>
      
      <div class="row">
        <div class="col-12">
          <h5 class="text-primary mb-3">Upcoming Appointments</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Doctor</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for appointment in upcoming_appointments %}
                <tr>
                  <td>{{ appointment.doctor.get_full_name }}</td>
                  <td>{{ appointment.schedule.date }}</td>
                  <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
                  <td>
                    {% if appointment.status == 'booked' %}
                      <span class="badge bg-primary">Scheduled</span>
                    {% elif appointment.status == 'completed' %}
                      <span class="badge bg-success">Completed</span>
                    {% elif appointment.status == 'cancelled' %}
                      <span class="badge bg-danger">Cancelled</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if appointment.status == 'booked' %}
                      <a href="{% url 'patients:edit_appointment' appointment.id %}" class="btn btn-sm btn-primary">Edit</a>
                      <a href="{% url 'patients:cancel_appointment' appointment.id %}" class="btn btn-sm btn-danger">Cancel</a>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center">No upcoming appointments found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Medical Records Tab -->
    <div class="tab-pane fade" id="medical-records" role="tabpanel" aria-labelledby="medical-records-tab">
      <h3>Medical Records</h3>
      {% if visits_page %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Doctor</th>
                <th>Diagnosis</th>
                <th>Symptoms</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              {% for visit in visits_page %}
                <tr>
                  <td>{{ visit.created_at|date:"M d, Y" }}</td>
                  <td>Dr. {{ visit.doctor.get_full_name }}</td>
                  <td><strong>{{ visit.diagnosis }}</strong></td>
                  <td>{{ visit.symptoms|truncatewords:10|default:"Not specified" }}</td>
                  <td>{{ visit.notes|truncatewords:10|default:"None" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-3">
          <nav>
            <ul class="pagination pagination-sm">
              {% if visits_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page_medicalvisit={{ visits_page.previous_page_number }}">&laquo; Previous</a>
                </li>
              {% endif %}
              <li class="page-item disabled">
                <span class="page-link">Page {{ visits_page.number }} of {{ visits_page.paginator.num_pages }}</span>
              </li>
              {% if visits_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page_medicalvisit={{ visits_page.next_page_number }}">Next &raquo;</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <div class="alert alert-info">No medical records yet.</div>
      {% endif %}
    </div>
    <!-- Prescriptions Tab -->
    <div class="tab-pane fade" id="prescriptions" role="tabpanel" aria-labelledby="prescriptions-tab">
      <h3>Prescriptions</h3>
      {% if prescriptions_page %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Medicine</th>
                <th>Dosage</th>
                <th>Frequency</th>
                <th>Duration</th>
                <th>Doctor</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in prescriptions_page %}
                <tr>
                  <td>{{ p.created_at|date:"M d, Y" }}</td>
                  <td><strong>{{ p.medication.name }}</strong></td>
                  <td>{{ p.dosage }}</td>
                  <td>{{ p.frequency }}</td>
                  <td>{{ p.duration_days }} days</td>
                  <td>Dr. {{ p.doctor.get_full_name }}</td>
                  <td>
                    <a href="{% url 'patients:download_prescription_pdf' p.id %}" 
                      class="btn btn-sm btn-outline-primary" 
                      title="Download PDF">
                      <i class="bi bi-download"></i> PDF
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-3">
          <nav>
            <ul class="pagination pagination-sm">
              {% if prescriptions_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page_prescription={{ prescriptions_page.previous_page_number }}">&laquo; Previous</a>
                </li>
              {% endif %}
              <li class="page-item disabled">
                <span class="page-link">Page {{ prescriptions_page.number }} of {{ prescriptions_page.paginator.num_pages }}</span>
              </li>
              {% if prescriptions_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page_prescription={{ prescriptions_page.next_page_number }}">Next &raquo;</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <div class="alert alert-info">No prescriptions yet.</div>
      {% endif %}
    </div>
    <!-- Billing Tab -->
    <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
      <h3>Billing</h3>
      {% if bills_page %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Doctor</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for bill in bills_page %}
                <tr>
                  <td>{{ bill.created_at|date:"M d, Y" }}</td>
                  <td>
                    {% if bill.appointment %}
                      Dr. {{ bill.appointment.doctor.get_full_name }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>{{ bill.description|truncatewords:10 }}</td>
                  <td>â‚¹{{ bill.amount }}</td>
                  <td>
                    {% if bill.is_paid %}
                      <span class="badge bg-success">Paid</span>
                    {% else %}
                      <span class="badge bg-warning">Unpaid</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if not bill.is_paid %}
                      <a href="{% url 'patients:pay_bill' bill.id %}" class="btn btn-sm btn-success">Pay</a>
                    {% else %}
                      <span class="text-muted">Paid</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-3">
          <nav>
            <ul class="pagination pagination-sm">
              {% if bills_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page_billing={{ bills_page.previous_page_number }}">&laquo; Previous</a>
                </li>
              {% endif %}
              <li class="page-item disabled">
                <span class="page-link">Page {{ bills_page.number }} of {{ bills_page.paginator.num_pages }}</span>
              </li>
              {% if bills_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page_billing={{ bills_page.next_page_number }}">Next &raquo;</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <div class="alert alert-info">No bills yet.</div>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="education" role="tabpanel" aria-labelledby="education-tab">
      <h3>Health Education</h3>
      <div class="row row-cols-1 row-cols-md-3 g-3 mt-3">
        <div class="col">
          <div class="card p-3 shadow-sm">
            <h5>Healthy Eating</h5>
            <p>Learn about balanced diets and nutrition.</p>
          </div>
        </div>
        <div class="col">
          <div class="card p-3 shadow-sm">
            <h5>Exercise Tips</h5>
            <p>Guidance on staying active and fit.</p>
          </div>
        </div>
        <div class="col">
          <div class="card p-3 shadow-sm">
            <h5>Mental Health</h5>
            <p>Resources for mental well-being.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if messages %}
  {% for message in messages %}
    {% if message.tags == 'success' %}
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          // Create toast element dynamically (or use existing one in base.html)
          const toastEl = document.createElement('div');
          toastEl.className = 'toast';
          toastEl.role = 'alert';
          toastEl.innerHTML = `
            <div class="toast-header bg-success text-white">
              <strong class="me-auto">Success</strong>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
              {{ message|escapejs }}
            </div>
          `;

          // Append to container
          const container = document.getElementById('notification-container') || 
                           document.body.appendChild(
                             Object.assign(document.createElement('div'), {
                               id: 'notification-container',
                               className: 'position-fixed top-0 end-0 p-3',
                               style: 'z-index: 1100; pointer-events: none;'
                             })
                           );

          container.appendChild(toastEl);

          // Show toast
          new bootstrap.Toast(toastEl, { delay: 5000 }).show();
        });
      </script>
    {% endif %}
  {% endfor %}
{% endif %}
{% endblock %}
