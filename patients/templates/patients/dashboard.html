{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" role="tabpanel" style="min-height: calc(100vh - 200px);">
  <!-- Sidebar Navigation -->
  <nav class="flex-column nav nav-pills me-4 p-3 border rounded" style="min-width: 220px; background-color: #f8f9fa; max-height: calc(100vh - 200px); overflow-y: auto;" role="tablist" aria-orientation="vertical">
    <a class="nav-link mb-2 py-2 px-3 rounded active" id="overview-tab" data-bs-toggle="pill" href="#overview" role="tab" aria-controls="overview" aria-selected="true" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-house-fill me-2"></i> Overview
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="appointments-tab" data-bs-toggle="pill" href="#appointments" role="tab" aria-controls="appointments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-calendar-check-fill me-2"></i> Appointments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="medical-records-tab" data-bs-toggle="pill" href="#medical-records" role="tab" aria-controls="medical-records" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-file-earmark-text-fill me-2"></i> Medical Records
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="billing-tab" data-bs-toggle="pill" href="#billing" role="tab" aria-controls="billing" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-credit-card-2-front-fill me-2"></i> Billing
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="education-tab" data-bs-toggle="pill" href="#education" role="tab" aria-controls="education" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-book-fill me-2"></i> Education
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="profile-tab" data-bs-toggle="pill" href="#profile" role="tab" aria-controls="profile" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-person-fill me-2"></i> Profile
    </a>
  </nav>

  <!-- Tab Content -->
  <div class="tab-content flex-grow-1 p-3 border rounded bg-white" style="max-height: calc(100vh - 200px); overflow-y: auto;">

    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="row g-3 mb-4">
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-calendar-check-fill fs-1 text-primary"></i>
            <h2>{{ upcoming_appointments|length }}</h2>
            <p>Upcoming Appointments</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-file-earmark-text-fill fs-1 text-success"></i>
            <h2>{{ medical_records_count }}</h2>
            <p>Medical Records</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-capsule-pill fs-1 text-info"></i>
            <h2>{{ active_prescriptions_count }}</h2>
            <p>Active Prescriptions</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-credit-card-2-front-fill fs-1 text-warning"></i>
            <h2>{{ unpaid_bills_count }}</h2>
            <p>Unpaid Bills</p>
          </div>
        </div>
      </div>
      <div class="col-md-5 p-3 border rounded bg-white">
        <h5>Latest Health Articles</h5>
        {% for article in latest_health_articles %}
            <div class="mb-3">
                <h6><a href="{% url 'patients:view_health_article' article.id %}">{{ article.title }}</a></h6>
                <small class="text-muted">By {{ article.author.get_full_name }} on {{ article.created_at|date:"M d" }}</small>
            </div>
        {% empty %}
            <p>No articles available.</p>
        {% endfor %}
    </div>
    </div>

    <!-- Appointments Tab -->
    <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="appointments-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Upcoming Appointments</h3>
        <div>
          <a href="{% url 'patients:book_appointment_form' %}" class="btn btn-primary me-2">Book New Appointment</a>
          <a href="{% url 'patients:appointments' %}" class="btn btn-outline-secondary">Appointment History</a>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Doctor</th>
              <th>Date</th>
              <th>Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in upcoming_appointments %}
            <tr>
              <td>{{ appointment.doctor.get_full_name }}</td>
              <td>{{ appointment.schedule.date }}</td>
              <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
              <td>
                {% if appointment.status == 'booked' %}
                  <span class="badge bg-primary">Scheduled</span>
                {% elif appointment.status == 'completed' %}
                  <span class="badge bg-success">Completed</span>
                {% elif appointment.status == 'cancelled' %}
                  <span class="badge bg-danger">Cancelled</span>
                {% endif %}
              </td>
              <td>
                {% if appointment.status == 'booked' %}
                  <a href="{% url 'patients:edit_appointment' appointment.id %}" class="btn btn-sm btn-primary">Edit</a>
                  <a href="{% url 'patients:cancel_appointment' appointment.id %}" class="btn btn-sm btn-outline-danger">Cancel</a>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center">No upcoming appointments found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Medical Records Tab -->
    <div class="tab-pane fade" id="medical-records" role="tabpanel" aria-labelledby="medical-records-tab">
      <h3 style="margin-bottom: 20px; color: #2c3e50; font-weight: 600;">Medical Records</h3>

      {% if medical_records_page.object_list %}
        <div class="table-responsive">
          <table class="table" style="width: 100%; border-collapse: collapse; font-size: 14px; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <thead style="background-color: #3498db; color: white;">
              <tr>
                <th style="padding: 14px; text-align: left; width: 15%;">Date</th>
                <th style="padding: 14px; text-align: left; width: 20%;">Doctor</th>
                <th style="padding: 14px; text-align: left; width: 15%;">Department</th>
                <th style="padding: 14px; text-align: left; width: 25%;">Diagnosis</th>
                <th style="padding: 14px; text-align: left; width: 20%;">Medicines</th>
                <th style="padding: 14px; text-align: center; width: 5%;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in medical_records_page.object_list %}
                <tr style="border-bottom: 1px solid #ecf0f1; height: 70px; transition: background-color 0.2s;">
                  <td style="padding: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ item.date|date:'M d, Y' }}">
                    {{ item.date|date:"M d, Y" }}
                  </td>
                  <td style="padding: 12px; color: #2980b9; font-weight: 500;" title="{{ item.doctor_name }}">
                    {{ item.doctor_name }}
                  </td>
                  <td style="padding: 12px; color: #7f8c8d;" title="{{ item.department }}">
                    {{ item.department }}
                  </td>
                  <td style="padding: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ item.diagnosis }}">
                    {{ item.diagnosis }}
                  </td>
                  <td style="padding: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ item.medicines }}">
                    {{ item.medicines }}
                  </td>
                  <td style="padding: 12px; text-align: center;">
                    <a href="{% url 'patients:medical_record_detail' item.appointment.id %}" class="btn btn-sm btn-outline-primary">View</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-3">
          <nav aria-label="Medical records pagination">
            <ul class="pagination">
              {% if medical_records_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" 
                    href="?page_medical_records={{ medical_records_page.previous_page_number }}#medical-records">
                    Previous
                  </a>
                </li>
              {% endif %}
              <li class="page-item active">
                <span class="page-link">{{ medical_records_page.number }}</span>
              </li>
              {% if medical_records_page.has_next %}
                <li class="page-item">
                  <a class="page-link" 
                    href="?page_medical_records={{ medical_records_page.next_page_number }}#medical-records">
                    Next
                  </a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <p class="text-muted" style="font-style: italic; margin-top: 10px;">No medical records found.</p>
      {% endif %}
    </div>

    <!-- Billing Tab -->
    <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
      <h3>Billing</h3>

      {% if bills_page.object_list %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Doctor</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for bill in bills_page %}
                <tr>
                  <td>{{ bill.created_at|date:"M d, Y" }}</td>
                  <td>
                    {% if bill.appointment %}
                      Dr. {{ bill.appointment.doctor.get_full_name }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>{{ bill.description|truncatewords:10 }}</td>
                  <td>â‚¹{{ bill.amount }}</td>
                  <td>
                    {% if bill.is_paid %}
                      <span class="badge bg-success">Paid</span>
                    {% else %}
                      <span class="badge bg-warning">Unpaid</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if not bill.is_paid %}
                      <a href="{% url 'patients:pay_bill' bill.id %}" class="btn btn-sm btn-success">Pay</a>
                    {% else %}
                      <span class="text-muted">Paid</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-3">
          <nav aria-label="Billing pagination">
            <ul class="pagination">
              {% if bills_page.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page_bills={{ bills_page.previous_page_number }}#billing">
                    Previous
                  </a>
                </li>
              {% endif %}
              <li class="page-item active">
                <span class="page-link">{{ bills_page.number }}</span>
              </li>
              {% if bills_page.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page_bills={{ bills_page.next_page_number }}#billing">
                    Next
                  </a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% else %}
        <div class="alert alert-info">No bills yet.</div>
      {% endif %}
    </div>

    <!-- Health Education Tab -->
    <div class="tab-pane fade" id="education" role="tabpanel" aria-labelledby="education-tab">
        <h3 class="mb-4">Health Articles</h3>
        {% if health_articles %}
            <div class="row g-4">
                {% for article in health_articles %}
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border">
                            <div class="card-body">
                                <h5 class="card-title">{{ article.title }}</h5>
                                <p class="card-text text-muted">{{ article.content|truncatewords:50 }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        By {{ article.author.get_full_name }}
                                    </small>
                                    <a href="{% url 'patients:view_health_article' article.id %}" class="btn btn-primary btn-sm">Read More</a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-center mt-4">
                <nav>
                    <ul class="pagination pagination-sm">
                        {% if health_articles.has_previous %}
                            <li class="page-item"><a class="page-link" href="?page=1">&laquo; First</a></li>
                            <li class="page-item"><a class="page-link" href="?page={{ health_articles.previous_page_number }}">Previous</a></li>
                        {% endif %}
                        <li class="page-item disabled"><span class="page-link">Page {{ health_articles.number }} of {{ health_articles.paginator.num_pages }}</span></li>
                        {% if health_articles.has_next %}
                            <li class="page-item"><a class="page-link" href="?page={{ health_articles.next_page_number }}">Next</a></li>
                            <li class="page-item"><a class="page-link" href="?page={{ health_articles.paginator.num_pages }}">Last &raquo;</a></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        {% else %}
            <div class="alert alert-info">No articles available.</div>
        {% endif %}
    </div>

    <!-- Profile Tab -->
    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
      <h3>Your Profile</h3>

      <div class="d-flex align-items-center mb-4">
        <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}https://via.placeholder.com/100{% endif %}"
            alt="Profile Picture"
            class="rounded-circle me-3"
            width="100" height="100" style="object-fit: cover;">
        <div>
          <h4>{{ user.get_full_name }}</h4>
          <p class="text-muted mb-1">@{{ user.username }}</p>
          <p class="text-muted mb-0">Patient ID: {{ user.id }}</p>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <h5>Personal Information</h5>
          <p><strong>Full Name:</strong> {{ user.get_full_name }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Date of Birth:</strong> {{ user.date_of_birth|date:"M d, Y" }}</p>
          <p><strong>Gender:</strong> 
            {% if user.gender == 'M' %}Male
            {% elif user.gender == 'F' %}Female
            {% elif user.gender == 'O' %}Other
            {% else %}Not specified{% endif %}
          </p>
        </div>
        <div class="col-md-6">
          <h5>Contact Information</h5>
          <p><strong>Phone:</strong> {{ user.phone_number|default:"Not specified" }}</p>
          <p><strong>Address:</strong> {{ user.address|default:"Not specified" }}</p>
        </div>
      </div>

      <div class="mt-4">
        <a href="{% url 'patients:edit_profile' %}" class="btn btn-primary">
          <i class="bi bi-pencil-square me-2"></i> Edit Profile
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Tab & Pagination JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const hash = window.location.hash || '#overview';

    // Function to update URL without reload
    function updateUrl(newHash) {
      // Remove unrelated pagination params
      const cleanParams = new URLSearchParams();
      if (newHash === '#medical-records') {
        const page = urlParams.get('page_medical_records');
        if (page) cleanParams.set('page_medical_records', page);
      } else if (newHash === '#billing') {
        const page = urlParams.get('page_bills');
        if (page) cleanParams.set('page_bills', page);
      }
      // Other tabs (overview, appointments, education) don't need pagination

      const search = cleanParams.toString();
      const newUrl = `${window.location.pathname}${search ? '?' + search : ''}${newHash}`;
      history.replaceState(null, '', newUrl);
    }

    // Activate tab based on hash
    function activateTab() {
      const tabTrigger = document.querySelector(`[href="${hash}"]`);
      if (tabTrigger) {
        new bootstrap.Tab(tabTrigger).show();
      } else {
        // Fallback to overview
        const overviewTab = document.querySelector('#overview-tab');
        if (overviewTab) new bootstrap.Tab(overviewTab).show();
      }
      updateUrl(hash);
    }

    activateTab();

    // Handle tab clicks
    document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tabEl => {
      tabEl.addEventListener('click', function () {
        const newHash = this.getAttribute('href');
        setTimeout(() => {
          updateUrl(newHash);
        }, 50); // Slight delay to ensure tab is active
      });
    });

    // Update pagination links to preserve hash
    function updatePaginationLinks() {
      const activeTab = document.querySelector('.tab-pane.show.active');
      if (!activeTab) return;

      const links = activeTab.querySelectorAll('.pagination a.page-link');
      links.forEach(link => {
        const href = new URL(link.href, window.location.origin);
        href.hash = window.location.hash;
        link.href = href.toString();
      });
    }

    // Run on load and after tab switch
    updatePaginationLinks();
    document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tabEl => {
      tabEl.addEventListener('shown.bs.tab', updatePaginationLinks);
    });
  });
</script>
{% endblock %}