{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="d-flex" role="tabpanel" style="min-height: 100vh;">
  <nav class="flex-column nav nav-pills me-4 p-3 border rounded" style="min-width: 220px; background-color: #f8f9fa; max-height: calc(100vh - 100px); overflow-y: auto;" role="tablist" aria-orientation="vertical">
    <a class="nav-link mb-2 py-2 px-3 rounded active" id="overview-tab" data-bs-toggle="pill" href="#overview" role="tab" aria-controls="overview" aria-selected="true" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-house-fill me-2"></i> Overview
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="appointments-tab" data-bs-toggle="pill" href="#appointments" role="tab" aria-controls="appointments" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-calendar-check-fill me-2"></i> Appointments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="medical-records-tab" data-bs-toggle="pill" href="#medical-records" role="tab" aria-controls="medical-records" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-file-earmark-text-fill me-2"></i> Medical Records
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="active-prescriptions-tab" data-bs-toggle="pill" href="#active-prescriptions" role="tab" aria-controls="active-prescriptions" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-capsule-pill me-2"></i> Active Prescriptions
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="billing-tab" data-bs-toggle="pill" href="#billing" role="tab" aria-controls="billing" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-credit-card-2-front-fill me-2"></i> Billing
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="education-tab" data-bs-toggle="pill" href="#education" role="tab" aria-controls="education" aria-selected="false" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-book-fill me-2"></i> Education
    </a>
  </nav>
  <div class="tab-content flex-grow-1 p-3 border rounded bg-white">
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="row g-3 mb-4">
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-calendar-check-fill fs-1 text-primary"></i>
            <h2>{{ upcoming_appointments|length }}</h2>
            <p>Upcoming Appointments</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-file-earmark-text-fill fs-1 text-success"></i>
            <h2>{{ medical_records_count }}</h2>
            <p>Medical Records</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-capsule-pill fs-1 text-info"></i>
            <h2>{{ active_prescriptions|length }}</h2>
            <p>Active Prescriptions</p>
          </div>
        </div>
        <div class="col">
          <div class="card text-center p-3 shadow-sm">
            <i class="bi bi-credit-card-2-front-fill fs-1 text-warning"></i>
            <h2>{{ unpaid_bills|length }}</h2>
            <p>Unpaid Bills</p>
          </div>
        </div>
      </div>
      <div class="card p-3">
        <h4>Recent Activity</h4>
        {% if recent_activity %}
          <ul>
            {% for activity in recent_activity %}
              <li>{{ activity }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No recent activity to display.</p>
        {% endif %}
      </div>
    </div>
    <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="appointments-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Appointments</h3>
        <div>
          <a href="{% url 'patients:book_appointment_form' %}" class="btn btn-primary me-2">Book New Appointment</a>
          <a href="{% url 'patients:appointments' %}" class="btn btn-outline-secondary">Appointment History</a>
        </div>
      </div>
      
      <div class="row">
        <div class="col-12">
          <h5 class="text-primary mb-3">Upcoming Appointments</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Doctor</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for appointment in upcoming_appointments %}
                <tr>
                  <td>{{ appointment.doctor.get_full_name }}</td>
                  <td>{{ appointment.schedule.date }}</td>
                  <td>{{ appointment.schedule.start_time|time:"h:i A" }}</td>
                  <td>
                    {% if appointment.status == 'booked' %}
                      <span class="badge bg-primary">Scheduled</span>
                    {% elif appointment.status == 'completed' %}
                      <span class="badge bg-success">Completed</span>
                    {% elif appointment.status == 'cancelled' %}
                      <span class="badge bg-danger">Cancelled</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if appointment.status == 'booked' %}
                      <a href="{% url 'patients:edit_appointment' appointment.id %}" class="btn btn-sm btn-primary">Edit</a>
                      <a href="{% url 'patients:cancel_appointment' appointment.id %}" class="btn btn-sm btn-danger">Cancel</a>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center">No upcoming appointments found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="medical-records" role="tabpanel" aria-labelledby="medical-records-tab">
      <h3>Medical Records</h3>
      
      <!-- Completed Visits Table -->
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-calendar-check me-2"></i>Visit History
          </h5>
        </div>
        <div class="card-body">
          {% if completed_appointments %}
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Doctor</th>
                    <th>Visit Date & Time</th>
                    <th>Specialization</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for appointment in completed_appointments %}
                    {% if appointment.status == 'completed' %}
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                            <i class="bi bi-person-fill text-white"></i>
                          </div>
                          <div>
                            <strong>Dr. {{ appointment.doctor.get_full_name }}</strong>
                          </div>
                        </div>
                      </td>
                      <td>
                        <strong>{{ appointment.schedule.date|date:"M d, Y" }}</strong>
                        <br>
                        <small class="text-muted">{{ appointment.schedule.start_time|time:"h:i A" }}</small>
                      </td>
                      <td>
                        <span class="badge bg-secondary">{{ appointment.doctor.specialization|default:"General Practice" }}</span>
                      </td>
                      <td>
                        <span class="badge bg-success">Completed</span>
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <a href="{% url 'patients:visit_detail' appointment.id %}" class="btn btn-sm btn-primary" title="View Complete Details">
                            <i class="bi bi-eye me-1"></i>View Details
                          </a>
                          <a href="{% url 'patients:download_visit_pdf' appointment.id %}" class="btn btn-sm btn-outline-secondary" title="Download PDF">
                            <i class="bi bi-download me-1"></i>PDF
                          </a>
                        </div>
                      </td>
                    </tr>
                    {% endif %}
                  {% empty %}
                  <tr>
                    <td colspan="5" class="text-center">
                      <div class="py-4">
                        <i class="bi bi-calendar-x fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No completed visits found.</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="bi bi-calendar-x fs-1 text-muted"></i>
              <p class="text-muted mt-2">No completed visits found.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="prescriptions" role="tabpanel" aria-labelledby="prescriptions-tab">
      <h3>Prescriptions</h3>
      {% if prescriptions %}
      <table class="table table-striped mt-3">
        <thead>
          <tr>
            <th>Date</th>
            <th>Medication</th>
            <th>Dosage</th>
            <th>Instructions</th>
            <th>Prescribed By</th>
          </tr>
        </thead>
        <tbody>
          {% for prescription in prescriptions %}
          <tr>
            <td>{{ prescription.created_at|date:"Y-m-d" }}</td>
            <td>{{ prescription.medication.name }}</td>
            <td>{{ prescription.dosage }}</td>
            <td>{{ prescription.instructions }}</td>
            <td>{{ prescription.doctor.get_full_name }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No prescriptions found.</p>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
      <h3>Billing & Invoices</h3>
      {% if unpaid_bills %}
      <table class="table table-striped mt-3">
        <thead>
          <tr>
            <th>Service</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for bill in unpaid_bills %}
          <tr>
            <td>{{ bill.service_name }}</td>
            <td>{{ bill.due_date|date:"Y-m-d" }}</td>
            <td>{{ bill.amount }}</td>
            <td>{% if bill.is_paid %}Paid{% else %}Unpaid{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No billing records found.</p>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="active-prescriptions" role="tabpanel" aria-labelledby="active-prescriptions-tab">
      <h3>Active Prescriptions</h3>
      <p class="text-muted">Prescriptions that haven't been paid for yet</p>
      
      {% if active_prescriptions_unpaid %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Medication</th>
                <th>Dosage</th>
                <th>Instructions</th>
                <th>Doctor</th>
                <th>Amount Due</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in active_prescriptions_unpaid %}
              <tr>
                <td>{{ item.prescription.created_at|date:"Y-m-d" }}</td>
                <td>{{ item.prescription.medication.name }}</td>
                <td>{{ item.prescription.dosage }}</td>
                <td>{{ item.prescription.instructions|default:"As directed" }}</td>
                <td>{{ item.prescription.doctor.get_full_name }}</td>
                <td>${{ item.bill.amount }}</td>
                <td>
                  <a href="{% url 'patients:download_prescription_pdf' item.prescription.id %}" 
                     class="btn btn-sm btn-primary" title="Download PDF">
                    <i class="bi bi-download"></i> PDF
                  </a>
                  <a href="{% url 'patients:pay_bill' item.bill.id %}" 
                     class="btn btn-sm btn-success" title="Pay Bill">
                    <i class="bi bi-credit-card"></i> Pay
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> No active prescriptions with unpaid bills found.
        </div>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="education" role="tabpanel" aria-labelledby="education-tab">
      <h3>Health Education</h3>
      <div class="row row-cols-1 row-cols-md-3 g-3 mt-3">
        <div class="col">
          <div class="card p-3 shadow-sm">
            <h5>Healthy Eating</h5>
            <p>Learn about balanced diets and nutrition.</p>
          </div>
        </div>
        <div class="col">
          <div class="card p-3 shadow-sm">
            <h5>Exercise Tips</h5>
            <p>Guidance on staying active and fit.</p>
          </div>
        </div>
        <div class="col">
          <div class="card p-3 shadow-sm">
            <h5>Mental Health</h5>
            <p>Resources for mental well-being.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
