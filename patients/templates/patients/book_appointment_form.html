{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Main Card -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="bi bi-calendar-plus me-2"></i>
            Book an Appointment
          </h4>
        </div>
        <div class="card-body p-4">
          <form method="post" id="booking-form">
            {% csrf_token %}

            <!-- Department & Doctor Row -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="{{ form.department.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-building me-1 text-primary"></i>
                  {{ form.department.label }}
                </label>
                {{ form.department }}
                <div class="form-text text-muted">Choose a department to see available doctors.</div>
              </div>

              <div class="col-md-6">
                <label for="{{ form.doctor.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-person-badge me-1 text-primary"></i>
                  {{ form.doctor.label }}
                </label>
                {{ form.doctor }}
                <div class="invalid-feedback">Please select a doctor.</div>
              </div>
            </div>

            <!-- Working Schedule Panel -->
            <div class="alert alert-light border-info d-none mb-4" id="schedule-panel">
              <h6 class="mb-3 text-info">
                <i class="bi bi-clock-history me-1"></i>
                Doctor's Working Schedule
              </h6>
              <div id="schedule-list" class="row g-2"></div>
              <p class="text-muted mt-2 mb-0" id="no-schedule-message" style="display: none;">
                <i class="bi bi-exclamation-triangle"></i>
                This doctor has no working hours defined.
              </p>
            </div>

            <!-- Date & Time Row -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="{{ form.date.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-calendar-event me-1 text-success"></i>
                  {{ form.date.label }}
                </label>
                {{ form.date }}
                <div class="form-text">Select a date to view available time slots.</div>
              </div>

              <div class="col-md-6">
                <label for="{{ form.time.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-clock me-1 text-success"></i>
                  {{ form.time.label }}
                </label>
                {{ form.time }}
                <div class="form-text text-muted" id="time-status">Select doctor and date to load slots.</div>
              </div>
            </div>

            <!-- Symptoms -->
            <!-- <div class="mb-4">
              <label for="{{ form.symptoms.id_for_label }}" class="form-label fw-semibold">
                <i class="bi bi-clipboard-pulse me-1 text-danger"></i>
                {{ form.symptoms.label }}
              </label>
              {{ form.symptoms }}
              <div class="form-text">Briefly describe your symptoms or reason for visit.</div>
            </div>
            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                {{ form.non_field_errors }}
              </div>
            {% endif %}
            {% for field in form %}
              {% if field.errors %}
                <div class="alert alert-danger">
                  {{ field.label }}: {{ field.errors|join:", " }}
                </div>
              {% endif %}
            {% endfor %} -->
            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-2">
              <a href="#" onclick="history.back()" class="btn btn-outline-secondary px-4">
                <i class="bi bi-x-circle me-1"></i> Cancel
              </a>
              <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-check-circle me-1"></i> Book Appointment
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const deptSelect = document.getElementById('id_department');
  const doctorSelect = document.getElementById('id_doctor');
  const dateInput = document.getElementById('id_date');
  const timeSelect = document.getElementById('id_time');
  const schedulePanel = document.getElementById('schedule-panel');
  const scheduleList = document.getElementById('schedule-list');
  const timeStatus = document.getElementById('time-status');
  const noScheduleMessage = document.getElementById('no-schedule-message');

  // Hide schedule panel initially
  function hideSchedule() {
    schedulePanel.classList.add('d-none');
    scheduleList.innerHTML = '';
    noScheduleMessage.style.display = 'none';
  }

  // Show schedule
  function showSchedule() {
    schedulePanel.classList.remove('d-none');
  }

  // Update time slots
  function updateTimeSlots() {
    const doctorId = doctorSelect.value;
    const date = dateInput.value;
    if (!doctorId || !date) {
      timeSelect.innerHTML = '<option value="">Select doctor and date</option>';
      timeStatus.textContent = 'Select doctor and date to load time slots.';
      hideSchedule();
      return;
    }

    timeSelect.innerHTML = '<option value="">Loading...</option>';
    timeStatus.textContent = 'Loading available time slots...';
    hideSchedule();

    const url = `{% url 'patients:get_available_time_slots' %}?doctor_id=${encodeURIComponent(doctorId)}&date=${encodeURIComponent(date)}`;

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        timeSelect.innerHTML = '<option value="">Select Time</option>';
        if (data.available_slots && data.available_slots.length > 0) {
          data.available_slots.forEach(timeStr => {
            const option = document.createElement('option');
            option.value = timeStr;
            option.textContent = timeStr;
            timeSelect.appendChild(option);
          });
          timeStatus.textContent = 'Available time slots loaded.';
        } else {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No available time slots';
          timeSelect.appendChild(option);
          timeStatus.textContent = 'No available time slots for the selected date.';
        }

        // Fetch doctor's schedule
        const scheduleUrl = `{% url 'patients:get_doctor_schedule' %}?doctor_id=${encodeURIComponent(doctorId)}`;
        fetch(scheduleUrl)
          .then(response => response.json())
          .then(scheduleData => {
            scheduleList.innerHTML = '';
            if (scheduleData.success && scheduleData.working_hours.length > 0) {
              scheduleData.working_hours.forEach(day => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                  <div class="p-2 bg-light border rounded">
                    <strong>${day.day}:</strong>
                    ${day.start_time} â€“ ${day.end_time}
                  </div>
                `;
                scheduleList.appendChild(col);
              });
              noScheduleMessage.style.display = 'none';
              showSchedule();
            } else {
              noScheduleMessage.style.display = 'block';
              showSchedule();
            }
          })
          .catch(err => {
            console.error("Error loading schedule:", err);
            noScheduleMessage.textContent = "Failed to load working hours.";
            noScheduleMessage.style.display = 'block';
            showSchedule();
          });
      })
      .catch(error => {
        console.error('Error fetching time slots:', error);
        timeSelect.innerHTML = '<option value="">Error loading slots</option>';
        timeStatus.textContent = 'Failed to load time slots. Please try again.';
        hideSchedule();
      });
  }

  // Event listeners
  deptSelect.addEventListener('change', function () {
    const deptId = this.value;
    doctorSelect.innerHTML = '<option value="">Loading...</option>';
    timeSelect.innerHTML = '<option value="">Select doctor to load time slots</option>';
    timeStatus.textContent = '';
    hideSchedule();

    if (!deptId) {
      doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
      return;
    }

    const url = `{% url 'patients:get_doctors_by_department' %}?department_id=${encodeURIComponent(deptId)}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
        data.doctors.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name;
          doctorSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error fetching doctors:', error);
        doctorSelect.innerHTML = '<option value="">Error loading doctors</option>';
      });
  });

  doctorSelect.addEventListener('change', updateTimeSlots);
  dateInput.addEventListener('change', updateTimeSlots);
});
</script>

<!-- Optional: Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}