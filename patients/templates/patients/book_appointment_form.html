{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h2><i class="bi bi-calendar-plus"></i> Book Appointment</h2>
      <form method="post" id="booking-form">
        {% csrf_token %}
        <div class="mb-3">
          {{ form.department.label_tag }}
          {{ form.department }}
        </div>

        <div class="mb-3">
          {{ form.doctor.label_tag }}
          {{ form.doctor }}
        </div>

        <div class="mb-3">
          {{ form.date.label_tag }}
          {{ form.date }}
        </div>

        <div class="mb-3">
          {{ form.time.label_tag }}
          {{ form.time }}
        </div>

        <div class="mb-3">
          {{ form.symptoms.label_tag }}
          {{ form.symptoms }}
        </div>

        <button type="submit" class="btn btn-primary">Book Appointment</button>
        <a href="{% url 'patients:overview' %}" class="btn btn-secondary">Cancel</a>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const deptSelect = document.getElementById('id_department');
  const doctorSelect = document.getElementById('id_doctor');
  const dateInput = document.getElementById('id_date');
  const timeSelect = document.getElementById('id_time');

  deptSelect.addEventListener('change', function () {
    const deptId = this.value;
    doctorSelect.innerHTML = '<option value="">Loading...</option>';
    timeSelect.innerHTML = '<option value="">Select date to load time slots</option>';

    if (!deptId) {
      doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
      return;
    }

    fetch(`{% url 'patients:get_doctors_by_department' %}?department_id=${deptId}`)
      .then(response => response.json())
      .then(data => {
        doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
        data.doctors.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name;
          doctorSelect.appendChild(option);
        });
      });
  });

  function updateTimeSlots() {
    const doctorId = doctorSelect.value;
    const date = dateInput.value;
    if (!doctorId || !date) {
      timeSelect.innerHTML = '<option value="">Select date and doctor</option>';
      return;
    }

    timeSelect.innerHTML = '<option value="">Loading...</option>';
    fetch(`{% url 'patients:get_available_time_slots' %}?doctor_id=${doctorId}&date=${date}`)
      .then(response => response.json())
      .then(data => {
        timeSelect.innerHTML = '<option value="">Select Time</option>';
        if (data.available_slots.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No slots available';
          option.disabled = true;
          timeSelect.appendChild(option);
        } else {
          data.available_slots.forEach(slot => {
            const option = document.createElement('option');
            option.value = slot;
            option.textContent = slot;
            timeSelect.appendChild(option);
          });
        }
      });
  }

  doctorSelect.addEventListener('change', updateTimeSlots);
  dateInput.addEventListener('change', updateTimeSlots);
});
</script>
{% endblock %}