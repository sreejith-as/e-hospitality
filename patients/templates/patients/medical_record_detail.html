{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Medical Record Details</h2>
    <a href="{% url 'patients:download_visit_pdf' appointment.id %}" class="btn btn-success">
      <i class="bi bi-download me-2"></i> Download PDF
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <!-- Patient Info -->
      <div class="row mb-4">
        <div class="col-md-6">
          <h5>Patient Information</h5>
          <p><strong>Name:</strong> {{ appointment.patient.get_full_name }}</p>
          <p><strong>Email:</strong> {{ appointment.patient.email }}</p>
          <p><strong>Date of Birth:</strong> {{ appointment.patient.date_of_birth|date:"M d, Y" }}</p>
          <p><strong>Gender:</strong> {{ appointment.patient.gender|default:"Not specified" }}</p>
        </div>
        <div class="col-md-6">
          <h5>Visit Information</h5>
          <p><strong>Doctor:</strong> Dr. {{ appointment.doctor.get_full_name }}</p>
          <p><strong>Date:</strong> {{ appointment.schedule.date|date:"M d, Y" }}</p>
          <p><strong>Time:</strong> {{ appointment.schedule.start_time|time:"h:i A" }}</p>
          <p><strong>Symptoms:</strong> {{ appointment.symptoms|default:"Not specified" }}</p>
        </div>
      </div>

      <hr>

      <!-- Diagnosis -->
      <div class="mb-4">
        <h5>Diagnosis</h5>
        {% if diagnosis_notes %}
          <ul>
            {% for note in diagnosis_notes %}
              <li>{{ note.note }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No diagnosis recorded.</p>
        {% endif %}
      </div>

      <hr>

      <!-- Prescriptions -->
      <div class="mb-4">
        <h5>Prescriptions</h5>
        {% if prescriptions %}
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>Medicine</th>
                <th>Dosage</th>
                <th>Frequency</th>
                <th>Duration</th>
                <th>Instructions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in prescriptions %}
                <tr>
                  <td>{{ p.medication.name }}</td>
                  <td>{{ p.dosage }}</td>
                  <td>{{ p.frequency }}</td>
                  <td>{{ p.duration_days }} days</td>
                  <td>{{ p.instructions|default:"As directed" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No medicines prescribed.</p>
        {% endif %}
      </div>

      <hr>

      <!-- Billing Info -->
      <div class="mb-4">
        <h5>Billing Summary</h5>
        {% if bill %}
          <p><strong>Status:</strong> 
            <span class="badge bg-{% if bill.is_paid %}success{% else %}warning{% endif %}">
              {% if bill.is_paid %}
                Paid
              {% else %}
                Unpaid
              {% endif %}
            </span>
          </p>
          <p><strong>Amount:</strong> ₹{{ bill.amount }}</p>
          <p><strong>Due Date:</strong> {{ bill.due_date|date:"M d, Y" }}</p>
        {% else %}
          <p>No bill generated for this visit.</p>
        {% endif %}
      </div>
      
      <!-- Back Button -->
      <div class="mt-4">
        <a href="{% url 'patients:dashboard' %}#medical-records" class="btn btn-outline-secondary">
          ← Back to Medical Records
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}