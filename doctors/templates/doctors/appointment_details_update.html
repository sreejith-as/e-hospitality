{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-3, 5">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <!-- Page Title -->
      <div class="d-flex align-items-center mb-4">
        <i class="bi bi-journal-text text-primary me-2" style="font-size: 1.75rem;"></i>
        <h2 class="mb-0 text-primary">Prescribe & Diagnose — {{ appointment.patient.get_full_name }}</h2>
      </div>

      <!-- Patient & Appointment Card -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="bi bi-person-fill me-1 text-info"></i>
            Patient: {{ appointment.patient.get_full_name }}
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="d-flex mb-2">
                <strong class="text-muted me-2" style="min-width: 80px;">Date:</strong>
                <span>{{ appointment.schedule.date|date:"M d, Y" }}</span>
              </div>
              <div class="d-flex mb-2">
                <strong class="text-muted me-2" style="min-width: 80px;">Time:</strong>
                <span>{{ appointment.schedule.start_time|time:"h:i A" }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-2">
                <strong class="text-muted">Status:</strong>
                <span class="ms-1">
                  {% if appointment.status == 'booked' %}
                    <span class="badge bg-primary">Scheduled</span>
                  {% elif appointment.status == 'completed' %}
                    <span class="badge bg-success">Completed</span>
                  {% elif appointment.status == 'cancelled' %}
                    <span class="badge bg-danger">Cancelled</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ appointment.status|title }}</span>
                  {% endif %}
                </span>
              </div>
            </div>
          </div>

          <hr class="my-3">

          <div class="mb-3">
            <strong class="text-muted">Symptoms:</strong>
            <p class="ms-1 mt-1 text-dark">
              {{ appointment.symptoms|default:"No symptoms reported."|linebreaks }}
            </p>
          </div>
        </div>
      </div>

      <!-- Add Diagnosis & Prescription Form -->
<div class="card shadow-sm border-0">
  <div class="card-header bg-light">
    <h5 class="mb-0">
      <i class="bi bi-plus-circle text-success me-1"></i>
      Add Diagnosis and Prescription
    </h5>
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_diagnosis_and_prescription">

      <!-- Diagnosis Note -->
      <div class="mb-3">
        <label for="diagnosis_note" class="form-label fw-semibold">
          <i class="bi bi-clipboard-pulse text-danger me-1"></i>
          Diagnosis Note
        </label>
        <textarea
          class="form-control"
          id="diagnosis_note"
          name="diagnosis_note"
          rows="4"
          placeholder="e.g., Viral Fever, Hypertension, Diabetes"
          required
        ></textarea>
        <div class="form-text">Enter the primary diagnosis for this visit</div>
      </div>

      <!-- Medicine Search -->
      <div class="mb-3">
        <label for="medicine_search" class="form-label fw-semibold">
          <i class="bi bi-capsule text-primary me-1"></i>
          Search & Select Medicine
        </label>
        <div class="position-relative">
          <input
            type="text"
            class="form-control"
            id="medicine_search"
            placeholder="Start typing to search medicine..."
            autocomplete="off"
            required
          >
          <!-- Hidden input to store the selected medicine ID -->
          <input type="hidden" name="medicine_id" id="medicine_id" required>
          <div
            id="medicine_suggestions"
            class="position-absolute bg-white border shadow-sm rounded mt-1 w-100"
            style="display: none; max-height: 200px; overflow-y: auto; z-index: 1000;"
          ></div>
        </div>
        <div class="form-text">Select a medicine from the list</div>
        <!-- Display selected medicine name for confirmation -->
        <div id="selected_medicine_display" class="mt-2 text-success fw-semibold" style="display: none;"></div>
      </div>

      <!-- Dosage -->
      <div class="mb-3">
        <label for="dosage" class="form-label fw-semibold">
          <i class="bi bi-droplet text-info me-1"></i>
          Dosage
        </label>
        <input
          type="text"
          class="form-control"
          id="dosage"
          name="dosage"
          placeholder="e.g., 500mg, 1 tablet"
          required
        >
      </div>

      <!-- Frequency (Optional) -->
      <div class="mb-3">
        <label for="frequency" class="form-label fw-semibold">
          <i class="bi bi-arrow-repeat text-warning me-1"></i>
          Frequency (Optional)
        </label>
        <input
          type="text"
          class="form-control"
          id="frequency"
          name="frequency"
          placeholder="e.g., Twice Daily, Once Daily"
        >
        <div class="form-text">How often the medicine should be taken</div>
      </div>

        <!-- Duration (Optional) -->
        <div class="mb-3">
        <label for="duration_days" class="form-label fw-semibold">
          <i class="bi bi-calendar-day text-primary me-1"></i>
          Duration (Days) (Optional)
        </label>
        <input
          type="number"
          class="form-control"
          id="duration_days"
          name="duration_days"
          min="1"
          placeholder="e.g., 7, 14"
        >
        <div class="form-text">Number of days to take the medicine</div>
      </div>

      <!-- Instructions -->
      <div class="mb-3">
        <label for="instructions" class="form-label fw-semibold">
          <i class="bi bi-journal-text text-secondary me-1"></i>
          Instructions (Optional)
        </label>
        <textarea
          class="form-control"
          id="instructions"
          name="instructions"
          rows="3"
          placeholder="e.g., Take after meals, on an empty stomach"
        ></textarea>
        <div class="form-text">Specific usage instructions for the patient</div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success px-4" id="submit-btn" disabled>
          <i class="bi bi-check-circle me-1"></i> Save Diagnosis & Prescribe
        </button>
        <a href="#" onclick="history.back()" class="btn btn-outline-secondary px-4">
          <i class="bi bi-arrow-left me-1"></i> Back to Details
        </a>
      </div>
      </form>
      </div>
      </div>
    </div>
  </div>
</div>

<!-- Optional: Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<!-- Medicine Search Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('medicine_search');
    const suggestionsBox = document.getElementById('medicine_suggestions');
    const medicineIdInput = document.getElementById('medicine_id');
    const submitBtn = document.getElementById('submit-btn');
    const selectedMedicineDisplay = document.getElementById('selected_medicine_display');

    // Fetch medicines from template context (passed by the view)
    // Ensure 'all_medicines' is passed in the context by the view
    const medicines = [
      {% for med in all_medicines %}
        {
          id: {{ med.id }},
          name: "{{ med.name|escapejs }}",
          // Add other relevant fields if needed for display, e.g., unit, price
          unit: "{{ med.unit|escapejs }}",
          price: "{{ med.price|floatformat:2|escapejs }}"
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    // Show suggestions
    function showSuggestions(query) {
      suggestionsBox.innerHTML = '';
      if (!query) {
        suggestionsBox.style.display = 'none';
        return;
      }

      const filtered = medicines.filter(med =>
        med.name.toLowerCase().includes(query.toLowerCase()) //||
        //med.unit.toLowerCase().includes(query.toLowerCase()) // Optional: search by unit
      );

      if (filtered.length === 0) {
        const div = document.createElement('div');
        div.className = 'p-2 text-muted';
        div.textContent = 'No medicines found.';
        suggestionsBox.appendChild(div);
      } else {
        // Limit suggestions to improve performance
        filtered.slice(0, 15).forEach(med => {
          const div = document.createElement('div');
          div.className = 'p-2 border-bottom';
          div.style = 'cursor: pointer; font-size: 0.9rem;';
          // Display name and optionally unit/price
          div.innerHTML = `
            <strong>${med.name}</strong>
            ${med.unit ? `<small class="text-muted">(${med.unit})</small>` : ''}
            ${med.price ? `<br><small class="text-success">₹${med.price}</small>` : ''}
          `;
          div.addEventListener('click', () => {
            // On selection, populate the hidden ID field and the display area
            searchInput.value = med.name; // Show name in the search box
            medicineIdInput.value = med.id; // Store the ID
            selectedMedicineDisplay.textContent = `Selected: ${med.name}`;
            selectedMedicineDisplay.style.display = 'block';
            suggestionsBox.style.display = 'none';
            // Enable the submit button
            submitBtn.disabled = false;
          });
          suggestionsBox.appendChild(div);
        });
      }
      suggestionsBox.style.display = 'block';
    }

    // Debounce function to limit how often the search runs
    function debounce(func, delay) {
      let timeout;
      return function () {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // Event listeners
    searchInput.addEventListener('focus', () => {
      if (searchInput.value) showSuggestions(searchInput.value);
    });

    searchInput.addEventListener('input', debounce(() => {
      showSuggestions(searchInput.value);
    }, 300)); // 300ms delay

    // Click outside to close suggestions
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
        suggestionsBox.style.display = 'none';
      }
    });

    // Handle form reset (e.g., if user navigates back)
    // This might not be strictly necessary but good practice
    window.addEventListener('pageshow', function(event) {
      if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
        // Page was restored from cache (e.g., back button)
        // Reset state if needed
        const selectedId = medicineIdInput.value;
        if (selectedId) {
              const selectedMed = medicines.find(m => m.id == selectedId);
              if (selectedMed) {
                  selectedMedicineDisplay.textContent = `Selected: ${selectedMed.name}`;
                  selectedMedicineDisplay.style.display = 'block';
                  submitBtn.disabled = false;
              }
        }
      }
    });
  });
</script>
{% endblock %}