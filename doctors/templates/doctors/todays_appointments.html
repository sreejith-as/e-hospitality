{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary d-flex align-items-center">
      <i class="bi bi-calendar-check me-2"></i>
      Today's Appointments
    </h2>
    <a href="{% url 'doctors:dashboard' %}#appointments" class="btn btn-outline-secondary" onclick="history.back();">
      <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
    </a>
  </div>

  <!-- Search Form -->
  <form method="get" class="mb-4">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text bg-light">
            <i class="bi bi-search text-muted"></i>
          </span>
          <input
            type="text"
            class="form-control form-control-lg"
            name="search"
            id="searchAppointments"
            placeholder="Search by patient name or symptoms..."
            value="{{ search_query }}"
          >
          <button class="btn btn-outline-secondary" type="submit">Search</button>
        </div>
      </div>
    </div>
  </form>

  <!-- Appointments Table -->
  {% if appointments %}
    <div class="table-responsive shadow-sm rounded border">
      <table class="table table-hover align-middle mb-0" id="appointments-table">
        <thead class="table-light">
          <tr>
            <th>Patient</th>
            <th>Time</th>
            <th>Symptoms</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for appointment in appointments %}
            <tr data-search-term="{{ appointment.patient.get_full_name|lower }} {{ appointment.symptoms|default:''|lower }}">
              <td>
                <div class="d-flex align-items-center">
                  <div class="ms-2">
                    <strong>{{ appointment.patient.get_full_name }}</strong>
                    <div class="text-muted small">{{ appointment.patient.email }}</div>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge bg-info text-dark">
                  {{ appointment.schedule.start_time|time:"h:i A" }}
                </span>
              </td>
              <td>
                <span class="text-truncate d-block" style="max-width: 200px;">
                  {{ appointment.symptoms|default:"Not specified" }}
                </span>
              </td>
              <td>
                {% if appointment.status == 'booked' %}
                  <span class="badge bg-primary">Scheduled</span>
                {% elif appointment.status == 'completed' %}
                  <span class="badge bg-success">Completed</span>
                {% else %}
                  <span class="badge bg-secondary">Cancelled</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group" role="group">
                  <!-- Link to View Details (e.g., patient profile or visit note) -->
                  <a
                    href="{% url 'doctors:appointment_details' appointment.id %}"
                    class="btn btn-sm btn-outline-primary"
                    title="View Details"
                  >
                    <i class="bi bi-eye"></i> View
                  </a>
                  <a
                    href="{% url 'doctors:appointment_details_update' appointment.id %}"
                    class="btn btn-sm btn-outline-success"
                    title="View Details"
                  >
                    <i class="bi bi-eye"></i> Prescribe
                  </a>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-5">
                <i class="bi bi-calendar-x fs-1 d-block mb-3"></i>
                <p class="mb-0">No appointments scheduled for today.</p>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if appointments.has_other_pages %}
      <div class="d-flex justify-content-between align-items-center mt-4">
        <small class="text-muted">
          Showing {{ appointments.start_index }} to {{ appointments.end_index }} of {{ appointments.paginator.count }} appointments
        </small>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if appointments.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1&search={{ search_query }}">&laquo; First</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ appointments.previous_page_number }}&search={{ search_query }}">Previous</a>
              </li>
            {% endif %}
            <li class="page-item disabled">
              <span class="page-link">Page {{ appointments.number }} of {{ appointments.paginator.num_pages }}</span>
            </li>
            {% if appointments.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ appointments.next_page_number }}&search={{ search_query }}">Next</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ appointments.paginator.num_pages }}&search={{ search_query }}">Last &raquo;</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  {% else %}
    <div class="text-center py-5">
      <i class="bi bi-calendar-x fs-1 text-muted"></i>
      <p class="text-muted">No appointments found for today.</p>
    </div>
  {% endif %}
</div>

<!-- Simplified JavaScript (Only Live Search) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('searchAppointments');
  const tableRows = document.querySelectorAll('#appointments-table tbody tr');

  if (searchInput) {
    searchInput.addEventListener('keyup', function () {
      const term = searchInput.value.toLowerCase().trim();
      tableRows.forEach(row => {
        const text = row.getAttribute('data-search-term') || '';
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });
  }
});
</script>

<!-- Optional: Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}