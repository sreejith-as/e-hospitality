{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="d-flex" role="tabpanel" style="min-height: calc(100vh - 200px);">
  <nav class="flex-column nav nav-pills me-4 p-3 border rounded" style="min-width: 220px; background-color: #f8f9fa; max-height: calc(100vh - 100px); overflow-y: auto;" role="tablist" aria-orientation="vertical">
    <a class="nav-link mb-2 py-2 px-3 rounded" id="appointments-tab" data-bs-toggle="pill" href="#appointments" role="tab" aria-controls="appointments" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-calendar-check-fill me-2"></i> Appointments
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="patients-tab" data-bs-toggle="pill" href="#patients" role="tab" aria-controls="patients" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-people-fill me-2"></i> Patients
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="bills-tab" data-bs-toggle="pill" href="#bills" role="tab" aria-controls="bills" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-file-earmark-text me-2"></i> Bills
    </a>
    <a class="nav-link mb-2 py-2 px-3 rounded" id="profile-tab" data-bs-toggle="pill" href="#profile" role="tab" aria-controls="profile" style="font-weight: 600; font-size: 1.1rem;">
      <i class="bi bi-person-circle me-2"></i> Profile
    </a>
  </nav>
  <div class="tab-content flex-grow-1 p-3">
    <!-- Appointments Tab -->
    <div class="tab-pane fade" id="appointments" role="tabpanel" aria-labelledby="appointments-tab">
      <h3 class="mb-4">My Appointments</h3>
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h5>Today's Appointments</h5>
            <p class="fs-4">{{ todays_count }}</p>
            <a href="{% url 'doctors:todays_appointments' %}" class="btn btn-primary">View Today's Appointments</a>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h5>Upcoming Appointments</h5>
            <p class="fs-4">{{ upcoming_count }}</p>
            <a href="{% url 'doctors:upcoming_appointments' %}" class="btn btn-primary">View Upcoming Appointments</a>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h5>All Appointments</h5>
            <p class="fs-4">{{ appointments_count }}</p>
            <a href="{% url 'doctors:appointment_schedule' %}" class="btn btn-primary">View All Appointments</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Patients Tab -->
    <div class="tab-pane fade" id="patients" role="tabpanel" aria-labelledby="patients-tab">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">My Patients</h3>
        <!-- Search Form -->
        <form method="get" class="d-flex" id="search-form">
          <input
            type="text"
            name="search"
            class="form-control me-2"
            placeholder="Search by name or email..."
            value="{{ search_query }}"
            style="max-width: 300px;"
          >
          <button class="btn btn-outline-secondary" type="submit">Search</button>
        </form>
      </div>

      {% if patients %}
        <div class="row row-cols-1 row-cols-md-3 g-4">
          {% for patient in patients %}
            <div class="col">
              <div class="card h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column">
                  <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-person-circle fs-2 text-primary me-3"></i>
                    <div>
                      <h5 class="mb-0">{{ patient.get_full_name }}</h5>
                      <p class="text-muted mb-1">{{ patient.email }}</p>
                      <p class="text-muted mb-0">{{ patient.phone_number }}</p>
                    </div>
                  </div>
                  <div class="mt-auto">
                    <a href="{% url 'doctors:patient_detail' patient.id %}" class="btn btn-primary w-100">
                      <i class="bi bi-eye me-1"></i> View Details
                    </a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if patients.has_other_pages %}
          <div class="d-flex justify-content-center mt-4">
            <nav>
              <ul class="pagination pagination-sm">
                {% if patients.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1&search={{ search_query }}#patients">&laquo; First</a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ patients.previous_page_number }}&search={{ search_query }}#patients">Previous</a>
                  </li>
                {% endif %}
                <li class="page-item disabled">
                  <span class="page-link">Page {{ patients.number }} of {{ patients.paginator.num_pages }}</span>
                </li>
                {% if patients.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ patients.next_page_number }}&search={{ search_query }}#patients">Next</a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ patients.paginator.num_pages }}&search={{ search_query }}#patients">Last &raquo;</a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        {% endif %}
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
          <p class="text-muted mt-3">No patients found{% if search_query %} for "{{ search_query }}"{% endif %}.</p>
        </div>
      {% endif %}
    </div>

    <!-- Bills Tab -->
    <div class="tab-pane fade" id="bills" role="tabpanel" aria-labelledby="bills-tab">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">Today's Bills</h3>
            <a href="{% url 'doctors:all_bills' %}" class="btn btn-primary">View All Bills</a>
        </div>
        <form method="get" class="d-flex mb-3">
            <input type="text" name="search" class="form-control me-2" placeholder="Search by description..." value="{{ search_query }}">
            <button class="btn btn-outline-secondary" type="submit">Search</button>
        </form>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for bill in todays_bills %}
                <tr>
                    <td>{{ bill.description }}</td>
                    <td>â‚¹{{ bill.amount }}</td>
                    <td>{{ bill.get_status_display }}</td>
                    <td>
                        <a href="{% url 'doctors:bill_detail' bill.id %}" class="btn btn-info btn-sm">View</a>
                        <a href="{% url 'doctors:bill_edit' bill.id %}" class="btn btn-warning btn-sm">Edit</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center">No bills found for today.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if todays_bills.has_other_pages %}
        <nav>
            <ul class="pagination">
                {% if todays_bills.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&search={{ search_query }}#bills">&laquo; First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ todays_bills.previous_page_number }}&search={{ search_query }}#bills">Previous</a>
                </li>
                {% endif %}
                <li class="page-item disabled">
                    <span class="page-link">Page {{ todays_bills.number }} of {{ todays_bills.paginator.num_pages }}</span>
                </li>
                {% if todays_bills.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ todays_bills.next_page_number }}&search={{ search_query }}#bills">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ todays_bills.paginator.num_pages }}&search={{ search_query }}#bills">Last &raquo;</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
    
    <!-- Profile Tab -->
    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
      <h3 class="mb-4">Doctor Profile</h3>
      <div class="row g-4 align-items-center">
        <div class="col-md-4 text-center">
          {% if doctor.profile_picture %}
            <img src="{{ doctor.profile_picture.url }}" alt="Profile Picture" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
          {% else %}
            <i class="bi bi-person-circle fs-1 text-primary" style="width: 100px; height: 100px;"></i>
          {% endif %}
          <h4 class="mt-2">{{ doctor.get_full_name }}</h4>
          <p class="text-muted">
            {% if doctor_allocation %}
              {{ doctor_allocation.department.name }}
            {% else %}
              No department assigned
            {% endif %}
          </p>
        </div>
        <div class="col-md-8">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <dl class="row mb-0">
                <dt class="col-sm-4"><strong>Full Name</strong></dt>
                <dd class="col-sm-8">{{ doctor.get_full_name }}</dd>
                <dt class="col-sm-4"><strong>Email</strong></dt>
                <dd class="col-sm-8">{{ doctor.email }}</dd>
                <dt class="col-sm-4"><strong>Phone</strong></dt>
                <dd class="col-sm-8">{{ doctor.phone_number|default:"Not provided" }}</dd>
                <dt class="col-sm-4"><strong>Gender</strong></dt>
                <dd class="col-sm-8">{{ doctor.get_gender_display|default:"Not specified" }}</dd>
                <dt class="col-sm-4"><strong>Specialty</strong></dt>
                <dd class="col-sm-8">
                  {% if doctor_allocation %}
                    {{ doctor_allocation.department.name }} ({{ doctor.role|title }})
                  {% else %}
                    <span class="text-muted">No specialty assigned</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-4"><strong>Working Days</strong></dt>
                <dd class="col-sm-8">
                  {% if availability %}
                    {% for avail in availability %}
                      {{ avail.get_day_of_week_display }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  {% else %}
                    <span class="text-muted">Not set</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-4"><strong>Working Hours</strong></dt>
                <dd class="col-sm-8">
                  {% if availability %}
                    {% for avail in availability %}
                      <div class="mb-1">
                        <strong>{{ avail.get_day_of_week_display }}:</strong>
                        {{ avail.start_time|time:"g:i A" }} &ndash; {{ avail.end_time|time:"g:i A" }}
                      </div>
                    {% endfor %}
                  {% else %}
                    <span class="text-muted">Not set</span>
                  {% endif %}
                </dd>
              </dl>
            </div>
          </div>
          <div class="mt-3 text-end">
            <a href="{% url 'doctors:profile_update' %}" class="btn btn-primary px-4">
              <i class="bi bi-pencil me-1"></i> Update Profile
            </a>
            <a href="{% url 'accounts:change_password' %}" class="btn btn-secondary px-4">
              <i class="bi bi-lock me-1"></i> Change Password
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tab Activation & Form Handling Script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Get current hash from URL
  let hash = window.location.hash;
  
  // If no hash is present, default to appointments
  if (!hash || !['#appointments', '#patients', '#bills', '#profile'].includes(hash)) {
    hash = '#appointments';
    // Update URL without triggering page reload
    history.replaceState(null, null, window.location.pathname + window.location.search + hash);
  }
  
  const tabMapping = {
    '#appointments': '#appointments-tab',
    '#patients': '#patients-tab',
    '#bills': '#bills-tab',
    '#profile': '#profile-tab'
  };

  // Restore tab from hash
  function activateTab() {
    const tabSelector = tabMapping[hash];
    if (tabSelector) {
      const tabButton = document.querySelector(tabSelector);
      if (tabButton) {
        new bootstrap.Tab(tabButton).show();
      }
    }
  }

  // Run on load
  activateTab();

  // Ensure hash is preserved on form submit and pagination
  const searchForm = document.getElementById('search-form');
  if (searchForm) {
    searchForm.addEventListener('submit', function (e) {
      const formData = new FormData(searchForm);
      const search = formData.get('search') || '';
      const currentPage = new URLSearchParams(window.location.search).get('page') || '';
      let newUrl = '?';

      if (search) newUrl += `search=${encodeURIComponent(search)}&`;
      if (currentPage) newUrl += `page=${encodeURIComponent(currentPage)}&`;
      newUrl += `#patients`; // Always go to patients tab after submit

      // Update form action temporarily
      searchForm.action = newUrl;
    });
  }

  // Also ensure all pagination links include the correct hash
  document.querySelectorAll('.pagination a').forEach(link => {
    if (link.href.includes('#')) return; // Already has hash
    
    // Determine which tab this pagination belongs to
    let tabHash = '#patients'; // Default to patients
    if (link.href.includes('bills')) {
      tabHash = '#bills';
    }
    
    link.href = link.href + tabHash;
  });

  // Handle browser back/forward buttons
  window.addEventListener('hashchange', function () {
    hash = window.location.hash;
    activateTab();
  });

  // Update hash when tabs are clicked
  document.querySelectorAll('.nav-link[data-bs-toggle="pill"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (event) {
      const target = event.target.getAttribute('href');
      hash = target;
      // Update URL without triggering page reload
      history.replaceState(null, null, window.location.pathname + window.location.search + target);
    });
  });
});
</script>

<!-- Optional: Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}